# Brief survey on methods for attacking Tor hidden service

[Original URL](http://translate.wooyun.io/2015/09/19/Brief-survey-on-methods-for-attacking-Tor-hidden-service.html)

> Author:Phunter From:<http://drops.wooyun.org/papers/8265> Recently, MIT published an article for their recent work of identifying the hidden service of Tor by circuit fingerprinting with website...

Author:[Phunter](https://twitter.com/PhunterLau)

From:<http://drops.wooyun.org/papers/8265>

Recently, MIT published an [article](https://people.csail.mit.edu/devadas/pubs/circuit_finger.pdf) for their recent work of identifying the hidden service of Tor by circuit fingerprinting with website fingerprinting to eventually trace down the hidden service users. This paper has been discussed on reddit and many other forums, and the question that whether Tor can be compromised becomes hot again. Here I want to have a brief overview of recent research on the methods and attempts for attacking Tor hidden services over the past years. These methods are not my original creation and I try to introduce them in simple words. Some worth reading materials are provided at the ending part are for further review. In summary, Tor hidden services are very hard to compromise and mostly the following methods and attempts are heuristic analysis.

## 0x00 Brief introduction of Tor

The primary goal of Tor (The Onion Router) is to prevent traffic filter and sniffing from spying user's communication privacy. Most chinese people know it not for its encryption but for its multi-layered nodes which can bypass the Great Fire Wall (GFW). The general idea of Tor is that, each Tor user setups a local Tor proxy server which regularly communicates with other Tor users, therefore a topology circuit is constructed. Tor users encrypt the message to transmit in the application layer. The communication in between each routing pair is point-to-point encrypted and the routing pairs is just like layers of an onion. Such multi-layered topology structure is the same as place the client right at the heart of an onion which is exactly the methods that Tor uses to protect information sources. When a message is issued from the client, it will search for paths through network, go through multiple layer of proxy nodes and be sent in plain text form at exit layer, that's to say, the destination node can only see that the plain text is sent from the exit node but it doesn't know the actual location of the information source client. If attackers know the IP address of some Tor nodes, they might find the information source by querying the flowing direction of the entire information. So for each Tor proxy server, it's important to hide its own IP address.

![Please enter image description.](http://static.wooyun.org//drops/20150826/2015082606343588393.png)

reference from [wikipedia link](http://drops.wooyun.org/wp-content/uploads/2015/08/137.png)

Note that the point of attacking against Tor hidden services is not to obtain the transmitted message but to find out: which nodes are Tor's intermediate nodes, which users are using Tor and which Tor services are used. Because the message at the exit node is in a plain text form. If one knows the exit node, one knows the transmitted message, for example, parts of the leaked files from Wikileaks are captured at some Tor exit nodes.

## 0x01 Summary of Attacking Methods: general guildline

Tor is a complicated system. It has the complexity from its design, thus it may have vulnerablilities to be attacked for its complexity. Besides, its implementation plus server configurations are not perfect. Meanwhile, it also has some "stupid teammates" problems which can be leveraged for attacks. These aspects are the routine attacking points for targeting Tor's anonymity and privacy.

Attacks based on Tor's information characteristics usually leverage its encryption and network complexity. The popular method is wiretapping the pattern of network data. Because the information is encrypted through multi-layered nodes, Tor's traffic pattern is different from normal network data transmission, in determining the time of link and the special pattern of network data. A Tor node could generally be identified by listening to the data transmission pattern of a node. The transmitted information contains some intrinsic features (such as [keystroke frequency pattern](http://www.welivesecurity.com/2015/07/29/keystroke-biometrics-exploit-defeats-tor-privacy/)), as a result, the encrypted traffic with these features from the source of Tor to the destination may also contain some traceable features. For example, if the attacker designs some experiments, the sequence of message communication can be used to detect the location of a Tor node. Most of the research work of attacking Tor's anonymity focuses on this aspect, including the recent method mentioned in MIT's article that is circuit fingerprinting on Tor's nodes. These methods are mostly nicely construction methods and many major research institutes (some are state-owned) are working on this direction.

Other approaches with "stupid teammates" that are based on attacking on Tor's implementation/configuration are often not enrolled in the research projects of all major research institutions, but like the status of it and social engineering in hacking attacks, it can become [Achilles' heel](https://en.wikipedia.org/wiki/Achilles%27_heel) in a special situation. The methods attacking Tor's implementation mainly are deceiving, for instance, to set Tor node under attacker's control to attract other Tor nodes to link. Methods attacking on Tor's Implementation and server configuration mostly lie in the fact that if a Tor server is not appropriately configured, Tor's other services may be compromised to leak the address of Tor services. For example, there is a kind of "stupid teammate" , a Tor proxy server node is also the node for other services. If a web application runs on it (for example, the PHP version is old and contains many exploits), an attacker may penetrate the system using the vulnerable web services so long as the attacker can get the shell to scan the entire machine and determine if there's Tor running on it. Recently, a "stupid teammate" is bitcoin exchange: some relevant research uses bitcoin transactions to detect the IP address of some nodes in Tor. Please read <http://orbilu.uni.lu/handle/10993/18679>. These methods will not be discussed here.

## 0x02 Some Work of the Great Fire Wall (GFW)\

Tor can also be used for bypassing the Great Fire Wall (GFW), because it can automatically monitor if related proxy node is reachable and redirect till it can connect to outside of the GFW. Therefore, the GFW doesn't like Tor. What more, the GFW hates Tor because the destination server can only see Tor's exit nodes. So a server located abroad can use Tor to disguise itself as a server inside China and provides services to bypass the GFW.

• The main research goal of GFW is not about finding the message source, but blocking Tor nodes and cutting off the connection, so these users who bypass the GFW will be blocked. There's no official documentation about the GFW for reasons that everyone knows, but based observation results, the GFW uses the following methods:<br>
• Block known IP nodes and Bridge nodes: GFW can block parts of known IP nodes and monitor the rest for further investigation. The purpose of monitoring is about collecting data transmitted among nodes, which can be used as the feature selection from data flow in GFW's machine learning models.<br>
• Set up some Tor nodes under GFW's control and attract other Tor nodes for connection and block.<br>
• Attacking non-SSL encrypted Tor nodes to collect data flow as features to analyze (Deep Package Investigation, DPI), then classifying if it is Tor node using machine learning plus artificial rules.

The advantage of GFW is that it can see real traffic data that other. Their methods use the traffic features and positive/negative samples collected from real traffic for their machine learning models. GFW can quickly detect any Tor encryption and changing in network structure. It can also perform much passive data collection work without being detected. It keeps GFW a secret from Tor's attack. As the goal of GFW 's work is blocking the connection instead of finding the message source or the user identities, it blocks a small portions of Tor nodes, where new arising nodes are constantly generated. So it won't cause huge damage to Tor's anonymity and privacy for now.

## 0x03 Research work outside China

The main objective of academic research is about compromising the privacy and anonymity of Tor, which is commonly found in papers from universities and research institutions, as well as United States National Security Agency's (NSA) public materials and accidentally leaked documents.

## 0x04 MIT's Work

As mention at the beginning of this article, MIT fingerprints the data flow circuits in Tor. Its primary target is not looking for Tor nodes or finding user information, but finding out if there is Tor hidden service in the network, which can design a web page fingerprint to attack the client or service location on Tor nodes (more information on webpage fingerprinting please refer to Cai et al "[Touching from a Distance: Website Fingerprinting Attacks and Defenses](http://www3.cs.stonybrook.edu/~xcai/fp.pdf)", basically the method is that, an attacker sets a client in Tor network to visit a specific webpage with a special fingerprint, track the message sent, get the features of Tor proxy nodes, such as the packet size and interval frequency, and it uses machine learning to classify). It uses a simple way to determine if there is Tor hidden services in the network: they set up a Tor node that is controlled by themselves (the attacker) when other Tor nodes and user links come in and after a while of message transmission, the attacker can count the number of data transferred and the number of packets sent as well as the sequence of construction circuits, so that the attacker can predict which Tor service (e.g. OpenWeb) that the user is using with a simple machine learning model. The reason why this method is powerful is that, it is passively collecting data rather than actively sending packets, therefore before revealing the Tor node information, the attacker can fly under the radar.

This is very interesting work, and it also includes in great detail of the full text. It is also a great reading material for beginners who want to learn Tor attacking. As for if it successfully compromises Tor's anonymity and privacy as claimed, here in this [reddit](https://www.reddit.com/r/TOR/comments/3f3ioo/mit_breaks_tor_anonymity_by_exploiting_entry_nodes/) discussion, everyone thought it's far from so-called "compromising".

## 0x05 IIIT's Work

[Chakravarty](https://sites.google.com/site/sambuddhochakravarty/) team from IIT leverages a Cisco NetFlow Gateway monitoring tool and designs a smart Perturbation experiment for detecting the relevance between the server and client messages. Many Cisco routers have a default tool called NetFlow, which provides all kind of statistical information, for example, the number of packages and bytes etc. Network administrators use this tool to check the pattern of network information and identify the cause of problems, for example network congestion. Chakravarty team designs such an experiment that it adds a special Perturbation to the pattern of the server traffic, causing the net flow in the gateway some statistical features and constantly send a certain of messages based on this perturbation feature. When this perturbation passes through the whole network, the perturbation feature from the client and the feature in the server show some statistical correlation. Based on this statistical correlation, the information source can be predicted. The team also provides further protection advice: obfuscating these network features that can cause the leak of perturbation feature on nodes, for example, delay sending the package, and hide these features.

Their experiment is more powerful than MIT's, because the experiment can be repeated on public Tor network. All they need is monitoring a small part of public Internet gateway, use gateway monitoring tools like netflow to observe enough Tor traffic information. This method is to actively detect Tor network, which differs from MIT's passive data collection. For further reading, please refer to <http://securityaffairs.co/wordpress/30202/hacking/tor-traffic-analysis-attack.html> and <http://resources.infosecinstitute.com/hacking-tor-network-follow/>. From the perspective of principle, GFW also uses similar methods to observe, but details remain unknown.

## 0x06 NSA Work: oh boy!

Our dear National Security Agency (NSA)'s working is relatively broad. It involves what node is a Tor node, which users use Tor, which Tor services and so on. NSA's main purpose is tracking Tor users. But NSA admits they still have a long way before completely breaking the Tor privacy and hidden services. They only attack a few specific users (these users who are successfully captured are generally using a [Cookie cache Leakge](https://edwardsnowden.com/wp-content/uploads/2013/10/tor-stinks-presentation.pdf) approach, there are some users who technically don't know how to use Tor, and carelessly download a software suite to connect to a NSA controlled Tor server, causing them being detected.) None of the following information is NSA initiatively provided.

![Please enter image description.](http://static.wooyun.org//drops/20150826/2015082606343676126.png)

Picture credit from <http://yalasu.com/an-open-letter-to-asu-president-michael-crow/>

## "Stupid Teammate" Methods

The "stupid teammate" of Tor is the browser (mostly Firefox), and the well known Flash, plus some web scripts. Most of the users don't really understand the working principles and methods of Tor, and they tend to choose some [one-click installation Tor browser](http://www.darkreading.com/risk-management/fbi-admits-to-tor-server-takeover/d/d-id/1111553) suite which might contain something they don't know, like Firefox browser with known vulnerabilities, vulnerable Flash Player etc. For example, a user who installs the complete Baidu programs does not necessarily know what these components are. Agencies like FBI, NSA, take advantage of users who have these packages installed, attack their web browsers and Flash, and exploit the privacy and anonymity of Tor users. However, this method demonstrates that agencies such as NSA actually has no good way to directly attack Tor, thus they have to research on these "stupid teammates" and primarily target them.

## 0x07 FoxAcid Servers

NSA has a mysterious server code "FoxAcid". It's a type of Tor server under NSA control. It has a variety of usages, for example, if NSA wants to track a Tor user, they use some special methods to connect this user's circuit to one of NSA's FoxAcid server, and ensure long term of connection. NSA also prepares for some further attacking work by planting malwares into user's computer, and makes sure the user connects to the FoxAcid server for a long period of time. It's said that these FoxAcid servers are Windows Server 2003, and these Trojan malwre can still connect to the FoxAcid even if users restart the computer.

## Amazingly good teammates and webpage fingerprints

In addition to the use of stupid teammates, NSA has some amazing good teammates: the communications operators. NSA may request American telecommunications operators to provide data of a specific user, and operators such as AT&T will not hesitate to cooperate with. NSA will implant a specific fingerprint information in a Web page, if users access this website through Tor, NSA can track the flow of data from the user visited the Web page through operator's data. In my opinion, in theory GFW may also have similar work, but their primary goal is tracking users, so they may just block these Tor IPs.

For further reading, please refer to <http://www.networkcomputing.com/networking/nsa-battles-tor-9-facts/d/d-id/1111857?>

## 0x08 Summary

Thank you for reading such a long review. Attacks on Tor anonymity and privacy is a popular topic, both in academic and industrial, there are many aspects for attacks. Attack methods are usually in two types, one is distinguishing data flow pattern from normal traffic caused by Tor's encryption characteristic. The other one uses the weakness of the constructed Tor nodes and other related services. Each agency leverages unique methods to attack Tor because of different goals. Great Fire Wall's primary goal is blocking the connection, so they want to find out the location of the Tor nodes and block them, as a result, their methods lie in the detection of network traffic patterns; NSA wants keep tracking users, so their main targets are the users and the Tor chain that users pass through, therefore, they have researched and experimented multiple methods on tracking users. MIT's work is more interesting, the paper itself is a detailed description of circuit fingerprinting attack that I suggest reading, where IIIT team's work is a method that actively probes Tor.
