<!DOCTYPE html><html><head><title>Immutable Infrastructure with AWS and Ansible – Part 2 – Workstation</title></head><body>
<h1>Immutable Infrastructure with AWS and Ansible – Part 2 – Workstation</h1><p><a href="http://vcdxpert.com/?p=148" target="_new">Original URL</a></p>
<p><blockquote>In the first part of this series, we setup our workstation so that it could communicate with the Amazon Web Services APIs, and setup our AWS account so that it was ready to provision EC2 compute&hellip;</blockquote></p>
<div><div class="clearfix entry-content">
		
<p>In the <a href="http://vcdxpert.com/?p=105">first part of this series</a>, we setup our workstation so that it could communicate with the Amazon Web Services APIs, and setup our AWS account so that it was ready to provision EC2 compute infrastructure. &#xA0;In this section, we&#x2019;ll start building our Ansible playbook that will provision immutable infrastructure.</p>
<h2>Ansible Dynamic Inventory</h2>
<p>When working with cloud resources, Ansible has the capability of using a dynamic inventory system to find and configure all of your instances within AWS, or any other cloud provider. &#xA0;In order for this to work properly, we need to setup the EC2 external&#xA0;inventory script in our playbook.</p>
<ol>
<li>First, create the playbook folder (I named mine ~/immutable) and the inventory folder within it:<br>
<code>mkdir -p ~/immutable/inventory;cd ~/immutable/inventory</code></li>
<li>Next, download the EC2 external inventory script from Ansible:<br>
<code>wget https://raw.github.com/ansible/ansible/devel/contrib/inventory/ec2.py</code></li>
<li>Make the script executable by typing:<br>
<code>chmod +x ec2.py</code></li>
<li>Configure the EC2 external inventory&#xA0;script by creating a new file called ec2.ini in the inventory folder alongside the ec2.py script. &#xA0;If you specify the region you are working with, you will significantly decrease the execution time because the script will not need to scan every EC2 region for instances. &#xA0;Here is a copy of my ec2.ini file, configured to use the us-east-1 region:<br>


		<div id="crayon-56a7ce17a9ea0943689685" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num">100</p><p class="crayon-num">101</p><p class="crayon-num crayon-striped-num">102</p><p class="crayon-num">103</p><p class="crayon-num crayon-striped-num">104</p><p class="crayon-num">105</p><p class="crayon-num crayon-striped-num">106</p><p class="crayon-num">107</p><p class="crayon-num crayon-striped-num">108</p><p class="crayon-num">109</p><p class="crayon-num crayon-striped-num">110</p><p class="crayon-num">111</p><p class="crayon-num crayon-striped-num">112</p><p class="crayon-num">113</p><p class="crayon-num crayon-striped-num">114</p><p class="crayon-num">115</p><p class="crayon-num crayon-striped-num">116</p><p class="crayon-num">117</p><p class="crayon-num crayon-striped-num">118</p><p class="crayon-num">119</p><p class="crayon-num crayon-striped-num">120</p><p class="crayon-num">121</p><p class="crayon-num crayon-striped-num">122</p><p class="crayon-num">123</p><p class="crayon-num crayon-striped-num">124</p><p class="crayon-num">125</p><p class="crayon-num crayon-striped-num">126</p><p class="crayon-num">127</p><p class="crayon-num crayon-striped-num">128</p><p class="crayon-num">129</p><p class="crayon-num crayon-striped-num">130</p><p class="crayon-num">131</p><p class="crayon-num crayon-striped-num">132</p><p class="crayon-num">133</p><p class="crayon-num crayon-striped-num">134</p><p class="crayon-num">135</p><p class="crayon-num crayon-striped-num">136</p><p class="crayon-num">137</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-1"><span class="crayon-p"># Ansible EC2 external inventory script settings</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-4"><span class="crayon-sy">[</span><span class="crayon-v">ec2</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-6"><span class="crayon-p"># to talk to a private eucalyptus instance uncomment these lines</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-7"><span class="crayon-p"># and edit edit eucalyptus_host to be the host name of your cloud controller</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-8"><span class="crayon-p">#eucalyptus = True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-9"><span class="crayon-p">#eucalyptus_host = clc.cloud.domain.org</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-11"><span class="crayon-p"># AWS regions to make calls to. Set this to 'all' to make request to all regions</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-12"><span class="crayon-p"># in AWS and merge the results together. Alternatively, set this to a comma</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-13"><span class="crayon-p"># separated list of regions. E.g. 'us-east-1,us-west-1,us-west-2'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-14"><span class="crayon-v">regions</span><span class="crayon-o">=</span><span class="crayon-v">us</span><span class="crayon-o">-</span><span class="crayon-v">east</span><span class="crayon-o">-</span><span class="crayon-cn">1</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-15"><span class="crayon-v">regions_exclude</span><span class="crayon-o">=</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-17"><span class="crayon-p"># When generating inventory, Ansible needs to know how to address a server.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-18"><span class="crayon-p"># Each EC2 instance has a lot of variables associated with it. Here is the list:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-19"><span class="crayon-p">#&#xA0;&#xA0; http://docs.pythonboto.org/en/latest/ref/ec2.html#module-boto.ec2.instance</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-20"><span class="crayon-p"># Below are 2 variables that are used as the address of a server:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-21"><span class="crayon-p">#&#xA0;&#xA0; - destination_variable</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-22"><span class="crayon-p">#&#xA0;&#xA0; - vpc_destination_variable</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-24"><span class="crayon-p"># This is the normal destination variable to use. If you are running Ansible</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-25"><span class="crayon-p"># from outside EC2, then 'public_dns_name' makes the most sense. If you are</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-26"><span class="crayon-p"># running Ansible from within EC2, then perhaps you want to use the internal</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-27"><span class="crayon-p"># address, and should set this to 'private_dns_name'. The key of an EC2 tag</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-28"><span class="crayon-p"># may optionally be used; however the boto instance variables hold precedence</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-29"><span class="crayon-p"># in the event of a collision.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-30"><span class="crayon-v">destination_variable</span><span class="crayon-o">=</span><span class="crayon-v">public_dns_name</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-31"><span class="crayon-p">#destination_variable = private_dns_name</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-33"><span class="crayon-p"># For server inside a VPC, using DNS names may not make sense. When an instance</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-34"><span class="crayon-p"># has 'subnet_id' set, this variable is used. If the subnet is public, setting</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-35"><span class="crayon-p"># this to 'ip_address' will return the public IP address. For instances in a</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-36"><span class="crayon-p"># private subnet, this should be set to 'private_ip_address', and Ansible must</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-37"><span class="crayon-p"># be run from within EC2. The key of an EC2 tag may optionally be used; however</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-38"><span class="crayon-p"># the boto instance variables hold precedence in the event of a collision.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-39"><span class="crayon-p"># WARNING: - instances that are in the private vpc, _without_ public ip address </span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-40"><span class="crayon-p"># will not be listed in the inventory until You set:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-41"><span class="crayon-p">#vpc_destination_variable = private_ip_address</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-42"><span class="crayon-v">vpc_destination_variable</span><span class="crayon-o">=</span><span class="crayon-v">ip_address</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-44"><span class="crayon-p"># To tag instances on EC2 with the resource records that point to them from</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-45"><span class="crayon-p"># Route53, uncomment and set 'route53' to True.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-46"><span class="crayon-v">route53</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-48"><span class="crayon-p"># To exclude RDS instances from the inventory, uncomment and set to False.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-49"><span class="crayon-p">#rds = False</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-51"><span class="crayon-p"># To exclude ElastiCache instances from the inventory, uncomment and set to False.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-52"><span class="crayon-p">#elasticache = False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-54"><span class="crayon-p"># Additionally, you can specify the list of zones to exclude looking up in</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-55"><span class="crayon-p"># 'route53_excluded_zones' as a comma-separated list.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-56"><span class="crayon-p"># route53_excluded_zones = samplezone1.com, samplezone2.com</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-58"><span class="crayon-p"># By default, only EC2 instances in the 'running' state are returned. Set</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-59"><span class="crayon-p"># 'all_instances' to True to return all instances regardless of state.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-60"><span class="crayon-v">all_instances</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-62"><span class="crayon-p"># By default, only RDS instances in the 'available' state are returned.&#xA0;&#xA0;Set</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-63"><span class="crayon-p"># 'all_rds_instances' to True return all RDS instances regardless of state.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-64"><span class="crayon-v">all_rds_instances</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-66"><span class="crayon-p"># By default, only ElastiCache clusters and nodes in the 'available' state</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-67"><span class="crayon-p"># are returned. Set 'all_elasticache_clusters' and/or 'all_elastic_nodes'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-68"><span class="crayon-p"># to True return all ElastiCache clusters and nodes, regardless of state.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-70"><span class="crayon-p"># Note that all_elasticache_nodes only applies to listed clusters. That means</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-71"><span class="crayon-p"># if you set all_elastic_clusters to false, no node will be return from</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-72"><span class="crayon-p"># unavailable clusters, regardless of the state and to what you set for</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-73"><span class="crayon-p"># all_elasticache_nodes.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-74"><span class="crayon-v">all_elasticache_replication_groups</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-75"><span class="crayon-v">all_elasticache_clusters</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-76"><span class="crayon-v">all_elasticache_nodes</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-78"><span class="crayon-p"># API calls to EC2 are slow. For this reason, we cache the results of an API</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-79"><span class="crayon-p"># call. Set this to the path you want cache files to be written to. Two files</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-80"><span class="crayon-p"># will be written to this directory:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-81"><span class="crayon-p">#&#xA0;&#xA0; - ansible-ec2.cache</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-82"><span class="crayon-p">#&#xA0;&#xA0; - ansible-ec2.index</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-83"><span class="crayon-v">cache_path</span><span class="crayon-o">=</span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-sy">.</span><span class="crayon-v">ansible</span><span class="crayon-o">/</span><span class="crayon-v">tmp</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-85"><span class="crayon-p"># The number of seconds a cache file is considered valid. After this many</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-86"><span class="crayon-p"># seconds, a new API call will be made, and the cache file will be updated.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-87"><span class="crayon-p"># To disable the cache, set this value to 0</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-88"><span class="crayon-v">cache_max_age</span><span class="crayon-o">=</span><span class="crayon-cn">0</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-90"><span class="crayon-p"># Organize groups into a nested/hierarchy instead of a flat namespace.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-91"><span class="crayon-v">nested_groups</span><span class="crayon-o">=</span><span class="crayon-t">False</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-93"><span class="crayon-p"># The EC2 inventory output can become very large. To manage its size,</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-94"><span class="crayon-p"># configure which groups should be created.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-95"><span class="crayon-v">group_by_instance_id</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-96"><span class="crayon-v">group_by_region</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-97"><span class="crayon-v">group_by_availability_zone</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-98"><span class="crayon-v">group_by_ami_id</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-99"><span class="crayon-v">group_by_instance_type</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-100"><span class="crayon-v">group_by_key_pair</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-101"><span class="crayon-v">group_by_vpc_id</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-102"><span class="crayon-v">group_by_security_group</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-103"><span class="crayon-v">group_by_tag_keys</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-104"><span class="crayon-v">group_by_tag_none</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-105"><span class="crayon-v">group_by_route53_names</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-106"><span class="crayon-v">group_by_rds_engine</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-107"><span class="crayon-v">group_by_rds_parameter_group</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-108"><span class="crayon-v">group_by_elasticache_engine</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-109"><span class="crayon-v">group_by_elasticache_cluster</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-110"><span class="crayon-v">group_by_elasticache_parameter_group</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-111"><span class="crayon-v">group_by_elasticache_replication_group</span><span class="crayon-o">=</span><span class="crayon-t">True</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-113"><span class="crayon-p"># If you only want to include hosts that match a certain regular expression</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-114"><span class="crayon-p"># pattern_include = staging-*</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-116"><span class="crayon-p"># If you want to exclude any hosts that match a certain regular expression</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-117"><span class="crayon-p"># pattern_exclude = staging-*</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-119"><span class="crayon-p"># Instance filters can be used to control which instances are retrieved for</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-120"><span class="crayon-p"># inventory. For the full list of possible filters, please read the EC2 API</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-121"><span class="crayon-p"># docs: http://docs.aws.amazon.com/AWSEC2/latest/APIReference/ApiReference-query-DescribeInstances.html#query-DescribeInstances-filters</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-122"><span class="crayon-p"># Filters are key/value pairs separated by '=', to list multiple filters use</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-123"><span class="crayon-p"># a list separated by commas. See examples below.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-125"><span class="crayon-p"># Retrieve only instances with (key=value) env=staging tag</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-126"><span class="crayon-p"># instance_filters = tag:env=staging</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-128"><span class="crayon-p"># Retrieve only instances with role=webservers OR role=dbservers tag</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-129"><span class="crayon-p"># instance_filters = tag:role=webservers,tag:role=dbservers</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-131"><span class="crayon-p"># Retrieve only t1.micro instances OR instances with tag env=staging</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-132"><span class="crayon-p"># instance_filters = instance-type=t1.micro,tag:env=staging</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-134"><span class="crayon-p"># You can use wildcards in filter values also. Below will list instances which</span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-135"><span class="crayon-p"># tag Name value matches webservers1*</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ea0943689685-136"><span class="crayon-p"># (ex. webservers15, webservers1a, webservers123 etc) </span></p><p class="crayon-line" id="crayon-56a7ce17a9ea0943689685-137"><span class="crayon-p"># instance_filters = tag:Name=webservers1*</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>


</li>
<li>Next, create the default Ansible configuration for this playbook by editing a file in the root of the playbook directory (in our example, ~/immutable), named ansible.cfg. This file should have the following text in it:<br>


		<div id="crayon-56a7ce17a9eaf351969078" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			<p class="crayon-toolbar"><span class="crayon-title">ansible.cfg</span>
			</p>
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9eaf351969078-1"><span class="crayon-i ">[defaults]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eaf351969078-2">remote<span class="crayon-sy">_</span>user=ubuntu</p><p class="crayon-line" id="crayon-56a7ce17a9eaf351969078-3">host<span class="crayon-sy">_</span>key<span class="crayon-sy">_</span>checking=False</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eaf351969078-4">inventory=<span class="crayon-o">.</span>/inventory/ec2<span class="crayon-o">.</span>py</p><p class="crayon-line" id="crayon-56a7ce17a9eaf351969078-5"><span class="crayon-i ">[ssh_connection]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eaf351969078-6">control<span class="crayon-sy">_</span>path=<span class="crayon-sy">%</span><span class="crayon-sy">(</span>directory<span class="crayon-sy">)</span>s/<span class="crayon-sy">%</span><span class="crayon-ta">%C</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>


</li>
</ol>
<p>To test and ensure that this script is working properly (and that your boto credentials are setup properly), execute the following command:<br>
<code>./ec2.py --list</code><br>
You should see the following output:<br>
<a href="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-12.06.19-PM.png" rel="attachment wp-att-173"><img class="alignnone wp-image-173" src="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-12.06.19-PM-300x86.png%20300w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-12.06.19-PM-768x220.png%20768w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-12.06.19-PM.png%20944w" alt="Screen Shot 2016-01-22 at 12.06.19 PM" width="399"></a></p>
<h2>Ansible Roles</h2>
<p>Roles are a way to automatically load certain variables and tasks into an Ansible playbook, and allow you to reuse your tasks in a modular way. &#xA0;We will heavily (ab)use roles to make the tasks&#xA0;in our playbook reusable, since many of our infrastructure provisioning operations will use the same tasks repeatedly.</p>
<h3>Group Variables</h3>
<p>The following group variables will apply to any tasks&#xA0;configured in our playbook, unless we override them at the task level. &#xA0;This will allow us to specify a set of sensible defaults that will work for most provisioning use cases, but still have flexibility to change them when we need it. &#xA0;Start by creating a folder for your playbook (I called it immutable, but you can call it whatever you like), then create a group_vars folder underneath it:<br>
<code>cd ~immutable; mkdir group_vars</code><br>
Now, we can edit the file all.yml in that folder we just created, group_vars, to contain the following text. Please note that indentation is important in YAML syntax:</p>

		<div id="crayon-56a7ce17a9eb4932619690" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-1"><span class="crayon-o">---</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-2"><span class="crayon-c"># group_vars/all.yml</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-4"><span class="crayon-s ">region</span><span class="">: us-east-1</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-5"><span class="crayon-s ">zone</span><span class="">: us-east-1a # zone that the master AMI will be configured in</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-6"><span class="crayon-s ">keypair</span><span class="">: immutable</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-7"><span class="crayon-s ">security_groups</span><span class="">: ['default']</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-8"><span class="crayon-s ">instance_type</span><span class="">: t2.micro</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-9"><span class="crayon-c"># specify group_name on the command line with -e group_name=devX</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-10"><span class="crayon-s ">group_name</span><span class="">: test</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-11"><span class="crayon-s ">instances_min</span><span class="">: 1 # minimum number of instances in the auto scaling group</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-12"><span class="crayon-s ">instances_max</span><span class="">: 3 # maximum number of instances in the auto scaling group</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-13"><span class="crayon-s ">iam_profile</span><span class="">: "noaccess"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-14"><span class="crayon-s ">volumes</span><span class="">:</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-15"><span class="crayon-s ">- device_name</span><span class="">: /dev/sda1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-16"><span class="crayon-s ">device_type</span><span class="">: gp2</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb4932619690-17"><span class="crayon-s ">volume_size</span><span class="">: 8 # size of the root disk</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb4932619690-18"><span class="crayon-s ">delete_on_termination</span><span class="">: true</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>Now that our group_vars are setup, we can move onto creating our first role.</p>
<h3>The Launch Role</h3>
<p>The launch role performs an important first step &#x2013; it first searches for the latest Ubuntu 14.04 LTS (long term support) AMI (Amazon Machine Image) that is published by Canonical, the creators of Ubuntu, then launches a new EC2 compute instance, in the region and availability zone specified in our group_vars file. &#xA0;Note that the launch role also launches a very small compute instance (t2.micro) because this instance will only live for a short time while it is&#xA0;configured by subsequent tasks, then baked into a golden master AMI snapshot that lives in S3 object storage.</p>
<p>A quick note about Availability Zones: if you comment out the zone variable in our group_vars file, your instances will be launched in a random zone within the region specified. &#xA0;This can be useful if you want to ensure that an outage in a single AZ doesn&#x2019;t take down every instance in your auto-scaling group, but there is a trade-off as data transfer between zones incurs a charge, so if your database, for example, is in another zone, you&#x2019;ll pay a small network bandwidth fee to access it.</p>
<p>Create a new folder under your playbook directory called roles, and create a launch folder within it, then create a tasks folder under that, then edit a file called main.yml in this tasks folder:<br>
<code>mkdir -p roles/launch/tasks</code><br>
Now, put the following contents in the main.yml file:</p>

		<div id="crayon-56a7ce17a9eb8762005740" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-1"><span class="crayon-o">---</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-2"><span class="crayon-c"># roles/launch/tasks/main.yml</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-4"><span class="crayon-s ">- name</span><span class="">: Search for the latest Ubuntu 14.04 AMI</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-5"><span class="crayon-s ">ec2_ami_find</span><span class="">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-6"><span class="crayon-s ">region</span><span class="">: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>region<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-7"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;name: "</span>ubuntu/images/hvm-ssd/ubuntu-trusty-14<span class="crayon-o">.</span>04-amd64-server-*<span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-8"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;owner: 099720109477</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-9"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;sort: name</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-10"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;sort_order: descending</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-11"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;sort_end: 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-12"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;no_result_action: fail</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-13"><span class="crayon-i ">&#xA0;&#xA0;register: ami_result</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-15"><span class="crayon-i ">- name: Launch new instance</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-16"><span class="crayon-i ">&#xA0;&#xA0;ec2:</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-17"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;region: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>region<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-18"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;keypair: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>keypair<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-19"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;zone: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>zone<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-20"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;group: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>security<span class="crayon-sy">_</span>groups<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-21"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;image: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>ami<span class="crayon-sy">_</span>result<span class="crayon-o">.</span>results<span class="crayon-i ">[0]</span><span class="crayon-o">.</span>ami<span class="crayon-sy">_</span>id<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-22"><span class="crayon-i "># No point in creating an expensive instance just during the AMI configuration phase - let the ASG do that</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-23"><span class="crayon-i ">#&#xA0;&#xA0;&#xA0;&#xA0;instance_type: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>instance<span class="crayon-sy">_</span>type<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-24"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;instance_type: "</span>t2<span class="crayon-o">.</span>micro<span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-25"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;instance_tags:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-26"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;Name: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-27"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;volumes: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>volumes<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-28"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;wait: yes</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-29"><span class="crayon-i ">&#xA0;&#xA0;register: ec2</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-31"><span class="crayon-i ">- name: Add new instances to host group</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-32"><span class="crayon-i ">&#xA0;&#xA0;add_host:</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-33"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;name: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>item<span class="crayon-o">.</span>public<span class="crayon-sy">_</span>dns<span class="crayon-sy">_</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-34"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;groups: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-35"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;ec2_id: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>item<span class="crayon-o">.</span>id<span class="crayon-o">}</span><span class="crayon-o">}</span><span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-36"><span class="crayon-i ">&#xA0;&#xA0;with_items: ec2.instances</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-38"><span class="crayon-i ">- name: Wait for instance to boot</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-39"><span class="crayon-i ">&#xA0;&#xA0;wait_for:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-40"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;host: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>item<span class="crayon-o">.</span>public<span class="crayon-sy">_</span>dns<span class="crayon-sy">_</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span>"</p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-41"><span class="crayon-s ">port</span><span class="">: 22</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-42"><span class="crayon-s ">delay</span><span class="">: 30</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-43"><span class="crayon-s ">timeout</span><span class="">: 300</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9eb8762005740-44"><span class="crayon-s ">state</span><span class="">: started</span></p><p class="crayon-line" id="crayon-56a7ce17a9eb8762005740-45"><span class="crayon-s ">with_items</span><span class="">: ec2.instances</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>You&#x2019;ll notice that this launch role also waits for the instance to boot by waiting for port 22 (ssh) to be available on the host. This is useful because subsequent tasks will use an ssh connection to configure the system, so we want to ensure the system is completely booted before we proceed.</p>
<h3>The Workstation Role</h3>
<p>Now that we have a role that can launch a brand new t2.micro instance, our next role will allow us to configure this instance to be used as a workstation. &#xA0;This workstation configuration will be fairly simplistic, however, you can easily customize it as much as you want later. &#xA0;This is mainly just to illustrate how you would configure the golden image.</p>
<p>There are two directories we need to create for this role, the tasks directory, as well as the files directory, as there is an init script we want to populate onto the workstation that will create a swapfile on first boot:<br>
<code>mkdir -p roles/workstation/tasks;mkdir roles/workstation/files</code><br>
Next, we&#x2019;ll create the task:</p>

		<div id="crayon-56a7ce17a9ebc502313451" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			<p class="crayon-toolbar"><span class="crayon-title">Workstation Play</span>
			</p>
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num">100</p><p class="crayon-num">101</p><p class="crayon-num crayon-striped-num">102</p><p class="crayon-num">103</p><p class="crayon-num crayon-striped-num">104</p><p class="crayon-num">105</p><p class="crayon-num crayon-striped-num">106</p><p class="crayon-num">107</p><p class="crayon-num crayon-striped-num">108</p><p class="crayon-num">109</p><p class="crayon-num crayon-striped-num">110</p><p class="crayon-num">111</p><p class="crayon-num crayon-striped-num">112</p><p class="crayon-num">113</p><p class="crayon-num crayon-striped-num">114</p><p class="crayon-num">115</p><p class="crayon-num crayon-striped-num">116</p><p class="crayon-num">117</p><p class="crayon-num crayon-striped-num">118</p><p class="crayon-num">119</p><p class="crayon-num crayon-striped-num">120</p><p class="crayon-num">121</p><p class="crayon-num crayon-striped-num">122</p><p class="crayon-num">123</p><p class="crayon-num crayon-striped-num">124</p><p class="crayon-num">125</p><p class="crayon-num crayon-striped-num">126</p><p class="crayon-num">127</p><p class="crayon-num crayon-striped-num">128</p><p class="crayon-num">129</p><p class="crayon-num crayon-striped-num">130</p><p class="crayon-num">131</p><p class="crayon-num crayon-striped-num">132</p><p class="crayon-num">133</p><p class="crayon-num crayon-striped-num">134</p><p class="crayon-num">135</p><p class="crayon-num crayon-striped-num">136</p><p class="crayon-num">137</p><p class="crayon-num crayon-striped-num">138</p><p class="crayon-num">139</p><p class="crayon-num crayon-striped-num">140</p><p class="crayon-num">141</p><p class="crayon-num crayon-striped-num">142</p><p class="crayon-num">143</p><p class="crayon-num crayon-striped-num">144</p><p class="crayon-num">145</p><p class="crayon-num crayon-striped-num">146</p><p class="crayon-num">147</p><p class="crayon-num crayon-striped-num">148</p><p class="crayon-num">149</p><p class="crayon-num crayon-striped-num">150</p><p class="crayon-num">151</p><p class="crayon-num crayon-striped-num">152</p><p class="crayon-num">153</p><p class="crayon-num crayon-striped-num">154</p><p class="crayon-num">155</p><p class="crayon-num crayon-striped-num">156</p><p class="crayon-num">157</p><p class="crayon-num crayon-striped-num">158</p><p class="crayon-num">159</p><p class="crayon-num crayon-striped-num">160</p><p class="crayon-num">161</p><p class="crayon-num crayon-striped-num">162</p><p class="crayon-num">163</p><p class="crayon-num crayon-striped-num">164</p><p class="crayon-num">165</p><p class="crayon-num crayon-striped-num">166</p><p class="crayon-num">167</p><p class="crayon-num crayon-striped-num">168</p><p class="crayon-num">169</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-1"><span class="crayon-o">---</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-2"><span class="crayon-c"># roles/workstation/tasks/main.yml</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-3"><span class="crayon-s ">- name</span><span class="">: add timezone configuration</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-4"><span class="crayon-s ">command</span><span class="">: bash -c 'echo US/Eastern </span><span class="crayon-o">&gt;</span>/etc/timezone<span class="crayon-i ">'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-6"><span class="crayon-i ">&#xA0;&#xA0;- name: add kernel parameters to /etc/sysctl.d/60-custom.conf</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-7"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;blockinfile: |</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-8"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;dest=/etc/sysctl.d/60-custom.conf</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-9"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;create=yes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-10"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;content="# Auto-reboot linux 10 seconds after a kernel panic</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-11"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.panic = 10</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-12"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.panic_on_oops = 10</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-13"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.unknown_nmi_panic = 10</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-14"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.panic_on_unrecovered_nmi = 10</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-15"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.panic_on_io_nmi = 10</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-16"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Controls whether core dumps will append the PID to the core filename, useful for debugging multi-threaded applications</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-17"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.core_uses_pid = 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-18"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Turn on address space randomization - security is super important</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-19"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;kernel.randomize_va_space = 2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-20"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;vm.swappiness = 0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-21"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;vm.dirty_ratio = 80</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-22"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;vm.dirty_background_ratio = 5</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-23"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;vm.dirty_expire_centisecs = 12000</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-24"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;vm.overcommit_memory = 1</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-25"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# ------ VM ------</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-26"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;fs.file-max = 204708</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-27"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;#fs.epoll.max_user_instances = 4096</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-28"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;fs.suid_dumpable = 0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-29"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# ------ NETWORK SECURITY ------</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-30"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Turn on protection for bad icmp error messages</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-31"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.icmp_ignore_bogus_error_responses = 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-32"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Turn on syncookies for SYN flood attack protection</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-33"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_syncookies = 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-34"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_max_syn_backlog = 8096</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-35"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_synack_retries = 2</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-36"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_syn_retries = 2</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-37"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Log suspicious packets, such as spoofed, source-routed, and redirect</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-38"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.conf.all.log_martians = 1</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-39"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.conf.default.log_martians = 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-40"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Disables these ipv4 features, not very legitimate uses</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-41"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.conf.all.accept_source_route = 0</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-42"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.conf.default.accept_source_route = 0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-43"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# ------ NETWORK PERFORMANCE ------</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-44"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Netflix 2014 recommendations</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-45"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.core.netdev_max_backlog = 5000</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-46"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.core.rmem_max = 16777216</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-47"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.core.wmem_max = 16777216</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-48"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_wmem = 4096 12582912 16777216</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-49"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_rmem = 4096 12582912 16777216</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-50"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Allow reusing sockets in TIME_WAIT state for new connections</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-51"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_tw_reuse = 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-52"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Socket max connections waiting to get accepted; the listen() backlog.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-53"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Default is 128.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-54"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.core.somaxconn = 4096</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-55"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Decrease fin timeout. After telling the client we are closing, how long to wait for a FIN, ACK?</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-56"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Default is 60.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-57"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_fin_timeout = 10</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-58"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# Avoid falling back to slow start after a connection goes idle</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-59"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;# keeps our cwnd large with the keep alive connections</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-60"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;net.ipv4.tcp_slow_start_after_idle = 0"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-62"><span class="crayon-i ">&#xA0;&#xA0;- name: reload sysctl kernel parameter settings</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-63"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;command: bash -c '</span>sysctl-p/etc/sysctl<span class="crayon-o">.</span>d/60-custom<span class="crayon-o">.</span>conf<span class="crayon-i ">'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-65"><span class="crayon-i ">&#xA0;&#xA0;- name: copy swapfile init script</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-66"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;copy:&#xA0;&#xA0;src=aws-swap-init dest=/etc/init.d/aws-swap-init mode=0755</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-68"><span class="crayon-i ">&#xA0;&#xA0;- name: register swapfile init script</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-69"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;command: bash -c '</span>update-rc<span class="crayon-o">.</span>daws-swap-initdefaults<span class="crayon-i ">'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-71"><span class="crayon-i ">&#xA0;&#xA0;- name: add entries to sudoers</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-72"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;lineinfile: |</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-73"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;dest=/etc/sudoers.d/90-cloud-init-users</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-74"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;line="luke ALL=(ALL) NOPASSWD:ALL"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-76"><span class="crayon-i ">&#xA0;&#xA0;- name: add luke user account</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-77"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;user: name=luke uid=1001 comment="Luke Youngblood" createhome=yes shell=/bin/bash</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-79"><span class="crayon-i ">&#xA0;&#xA0;- name: accept Oracle license part 1</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-80"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;command: bash -c '</span>echodebconfshared/accepted-oracle-license-v1-1selecttrue<span class="crayon-o">|</span>/usr/bin/debconf-set-selections<span class="crayon-i ">'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-82"><span class="crayon-i ">&#xA0;&#xA0;- name: accept Oracle license part 2</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-83"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;command: bash -c '</span>echodebconfshared/accepted-oracle-license-v1-1seentrue<span class="crayon-o">|</span>/usr/bin/debconf-set-selections<span class="crayon-i ">'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-85"><span class="crayon-i ">&#xA0;&#xA0;- name: Update apt cache</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-86"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;apt: update_cache=yes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-88"><span class="crayon-i ">&#xA0;&#xA0;- name: Add apt key for ubuntu</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-89"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;apt_key: keyserver=keyserver.ubuntu.com id=E56151BF</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-91"><span class="crayon-i ">&#xA0;&#xA0;- name: Determine Linux distribution distributor</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-92"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;shell: lsb_release -is | tr '</span><span class="crayon-i ">'[:upper:]'</span><span class="crayon-i ">' '</span><span class="crayon-i ">'[:lower:]'</span><span class="crayon-i ">'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-93"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;register: release_distributor</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-95"><span class="crayon-i ">&#xA0;&#xA0;- name: Determine Linux distribution codename</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-96"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;command: lsb_release -cs</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-97"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;register: release_codename</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-99"><span class="crayon-i ">&#xA0;&#xA0;- name: Add Mesosphere repository to sources list</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-100"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;lineinfile: &gt;</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-101"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;dest=/etc/apt/sources.list.d/mesosphere.list</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-102"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;line="deb http://repos.mesosphere.io/{{ release_distributor.stdout }} {{ release_codename.stdout }} main"</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-103"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;mode=0644</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-104"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;create=yes</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-106"><span class="crayon-i ">&#xA0;&#xA0;- name: Add java apt repository</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-107"><span class="crayon-i ">&#xA0;&#xA0;&#xA0;&#xA0;apt_repository: repo='</span><span class="crayon-s ">ppa</span><span class="">:webupd8team/java'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-109"><span class="crayon-s ">- name</span><span class="">: Add Google Chrome key</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-110"><span class="crayon-s ">shell</span><span class="">: wget -q -O - https</span><span class="">://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-112"><span class="crayon-s ">- name</span><span class="">: Add Google Chrome repo</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-113"><span class="crayon-s ">copy</span><span class="">: </span><span class="crayon-o">&gt;</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-114">content=<span class="crayon-i ">"deb http://dl.google.com/linux/chrome/deb/ stable main"</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-115">dest=<span class="crayon-i ">"/etc/apt/sources.list.d/google-chrome.list"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-116">owner=root</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-117">group=root</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-118">mode=0644</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-120"><span class="crayon-s ">- name</span><span class="">: Update apt cache</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-121"><span class="crayon-s ">apt</span><span class="">: update_cache=yes</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-123"><span class="crayon-s ">- name</span><span class="">: Install packages</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-124"><span class="crayon-s ">apt</span><span class="">: pkg=</span><span class="crayon-o">{</span><span class="crayon-o">{</span>item<span class="crayon-o">}</span><span class="crayon-o">}</span>state=installed</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-125"><span class="crayon-s ">with_items</span><span class="">: </span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-126">-nfs-common</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-127">-oracle-java8-installer</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-128">-liblapack-dev</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-129">-libblas-dev</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-130">-gfortran</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-131">-ntp</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-132">-vnc4server</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-133">-xfce4</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-134">-xfce4-goodies</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-135">-emacs</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-136">-firefox</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-137">-git</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-138">-maven</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-139">-npm</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-140">-python-pip</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-141">-clusterssh</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-142">-graphviz</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-143">-google-chrome-stable</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-144">-python-numpy</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-145">-python-scipy</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-146">-python-dev</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-147">-python-nose</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-148">-g++</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-149">-libopenblas-dev</p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-151"><span class="crayon-s ">- name</span><span class="">: Install boto and run setup</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-152"><span class="crayon-s ">command</span><span class="">: bash -c 'git clone git</span><span class="">://github.com/boto/boto.git;cd /home/ubuntu/boto;python setup.py install'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-153"><span class="crayon-s ">args</span><span class="">:</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-154"><span class="crayon-s ">chdir</span><span class="">: /home/ubuntu</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-156"><span class="crayon-s ">- name</span><span class="">: Install bower</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-157"><span class="crayon-s ">command</span><span class="">: bash -c 'npm install -g bower'</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-159"><span class="crayon-s ">- name</span><span class="">: Install Theano</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-160"><span class="crayon-s ">command</span><span class="">: bash -c 'pip install Theano'</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-162"><span class="crayon-s ">- name</span><span class="">: Update all packages to the latest version</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-163"><span class="crayon-s ">apt</span><span class="">: upgrade=dist</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-165"><span class="crayon-s ">- name</span><span class="">: Create nodejs symlink</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-166"><span class="crayon-s ">file</span><span class="">: src=/usr/bin/nodejs dest=/usr/bin/node state=link</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ebc502313451-168"><span class="crayon-s ">- name</span><span class="">: execute dpkg-reconfigure</span></p><p class="crayon-line" id="crayon-56a7ce17a9ebc502313451-169"><span class="crayon-s ">command</span><span class="">: "dpkg-reconfigure -f noninteractive tzdata"</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>


<h4>Initializing a swap file automatically</h4>
<p>When you provision the Ubuntu 14.04 LTS instance, it won&#x2019;t have a swapfile by default. &#xA0;This is a bit risky because if you run out of memory your system could become unstable. &#xA0;This file should be placed in roles/workstation/files/aws-swap-init, where the task above will copy it to your workstation during the configuration process, so that a swap file will be created when the system is booted for the first time.</p>

		<div id="crayon-56a7ce17a9ec2088201689" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			<p class="crayon-toolbar"><span class="crayon-title">roles/workstation/files/aws-swap-init</span>
			</p>
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					<div class="crayon-nums-content"><p class="crayon-num crayon-striped-num">100</p><p class="crayon-num">101</p><p class="crayon-num crayon-striped-num">102</p><p class="crayon-num">103</p><p class="crayon-num crayon-striped-num">104</p><p class="crayon-num">105</p><p class="crayon-num crayon-striped-num">106</p><p class="crayon-num">107</p><p class="crayon-num crayon-striped-num">108</p><p class="crayon-num">109</p><p class="crayon-num crayon-striped-num">110</p><p class="crayon-num">111</p><p class="crayon-num crayon-striped-num">112</p><p class="crayon-num">113</p><p class="crayon-num crayon-striped-num">114</p><p class="crayon-num">115</p><p class="crayon-num crayon-striped-num">116</p></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-1"><span class="crayon-p">#!/bin/sh</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-3"><span class="crayon-c"># aws-swap-init</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-5"><span class="crayon-c"># chkconfig: 2345 99 10</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-6"><span class="crayon-c"># description: Check to see if epemeral disk is mounted. If it is, and swap doesn't exist, \</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-7"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;create swap equivalent to memory on the ephemeral drive. If it isn't, and \</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-8"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exist, create 4096MB of swap on /.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-9"><span class="crayon-c"># processname: aws-swap-init</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-11"><span class="crayon-c">### BEGIN INIT INFO</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-12"><span class="crayon-c"># Provides:&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;aws-swap-init</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-13"><span class="crayon-c"># Required-Start:&#xA0;&#xA0;&#xA0;&#xA0;$remote_fs $syslog</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-14"><span class="crayon-c"># Required-Stop:&#xA0;&#xA0;&#xA0;&#xA0; $remote_fs $syslog</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-15"><span class="crayon-c"># Default-Start:&#xA0;&#xA0;&#xA0;&#xA0; 2 3 4 5</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-16"><span class="crayon-c"># Default-Stop:&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;0 1 6</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-17"><span class="crayon-c"># Short-Description: Ensure swap is created and enabled</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-18"><span class="crayon-c"># Description:&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Check to see if epemeral disk is mounted. If it is, and swap doesn't exist,</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-19"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;create swap equivalent to memory on the ephemeral drive. If it isn't, and</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-20"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;exist, create 512MB of swap on /.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-21"><span class="crayon-c">### END INIT INFO</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-22"><span class="crayon-c"># Copyright 2012 Corsis</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-23"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;http://www.corsis.com/</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-25"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;Licensed under the Apache License, Version 2.0 (the "License");</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-26"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;you may not use this file except in compliance with the License.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-27"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;You may obtain a copy of the License at</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-29"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;http://www.apache.org/licenses/LICENSE-2.0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-31"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;Unless required by applicable law or agreed to in writing, software</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-32"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;distributed under the License is distributed on an "AS IS" BASIS,</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-33"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-34"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;See the License for the specific language governing permissions and</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-35"><span class="crayon-c">#&#xA0;&#xA0;&#xA0;&#xA0;limitations under the License.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-37"><span class="crayon-v">DEFAULTSIZE</span><span class="crayon-o">=</span><span class="crayon-cn">4194304</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-39"><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-40"><span class="crayon-c"># Check to see if there is swap mounted right now</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-41"><span class="crayon-c"># If there is, we're done here</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-42"><span class="crayon-v">ISSWAP</span><span class="crayon-o">=</span><span class="crayon-sy">`</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">cat</span><span class="crayon-o">/</span><span class="crayon-v">proc</span><span class="crayon-o">/</span><span class="crayon-v">meminfo</span><span class="crayon-o">|</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">grep</span><span class="crayon-v">SwapTotal</span><span class="crayon-o">|</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">awk</span><span class="crayon-s">'{print $2}'</span><span class="crayon-sy">`</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-43"><span class="crayon-st">if</span><span class="crayon-sy">[</span><span class="crayon-v">$ISSWAP</span><span class="crayon-o">-</span><span class="crayon-i">ne</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-44"><span class="crayon-st">then</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-45"><span class="crayon-r">exit</span><span class="crayon-cn">0</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-48"><span class="crayon-c"># What OS are we running?</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-49"><span class="crayon-st">if</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">system</span><span class="crayon-o">-</span><span class="crayon-v">release</span><span class="crayon-o">-</span><span class="crayon-v">o</span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">redhat</span><span class="crayon-o">-</span><span class="crayon-i">release</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-50"><span class="crayon-st">then</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-51"><span class="crayon-v">OSTYPE</span><span class="crayon-o">=</span><span class="crayon-s">"amzn"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-52"><span class="crayon-st">elif</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">f</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">lsb</span><span class="crayon-o">-</span><span class="crayon-i">release</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-53"><span class="crayon-st">then</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-54"><span class="crayon-v">OSTYPE</span><span class="crayon-o">=</span><span class="crayon-s">"ubuntu"</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-57"><span class="crayon-c"># Set the target directory. If unsupported platform, use root</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-58"><span class="crayon-st">case</span><span class="crayon-s">"$OSTYPE"</span><span class="crayon-st">in</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-59"><span class="crayon-v">amzn</span><span class="crayon-sy">)</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-60"><span class="crayon-v">TARGET</span><span class="crayon-o">=</span><span class="crayon-s">"/media/ephemeral0"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-62"><span class="crayon-v">ubuntu</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-63"><span class="crayon-v">TARGET</span><span class="crayon-o">=</span><span class="crayon-s">"/mnt"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-66"><span class="crayon-v">TARGET</span><span class="crayon-o">=</span><span class="crayon-s">"/"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-68"><span class="crayon-st">esac</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-70"><span class="crayon-c"># Does a swapfile already exist? If so, activate and be done</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-71"><span class="crayon-st">if</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-v">$TARGET</span><span class="crayon-o">/</span><span class="crayon-i">swapfile00</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-72"><span class="crayon-st">then</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-73"><span class="crayon-o">/</span><span class="crayon-v">sbin</span><span class="crayon-o">/</span><span class="crayon-i">swapon</span><span class="crayon-v">$TARGET</span><span class="crayon-o">/</span><span class="crayon-e">swapfile00</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-74"><span class="crayon-r">exit</span><span class="crayon-cn">0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-77"><span class="crayon-c"># OK, so there's no existing swapfile. Let's make one and activate it.</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-79"><span class="crayon-c"># If we're on an unsupported OS, or ephemeral disk isn't mounted, use a safe</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-80"><span class="crayon-c"># default size. Otherwise, use RAM size</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-81"><span class="crayon-st">if</span><span class="crayon-sy">[</span><span class="crayon-v">$TARGET</span><span class="crayon-o">=</span><span class="crayon-s">"/"</span><span class="crayon-sy">]</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-82"><span class="crayon-st">then</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-83"><span class="crayon-v">SIZE</span><span class="crayon-o">=</span><span class="crayon-v">$DEFAULTSIZE</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-84"><span class="crayon-st">else</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-85"><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-v">mount</span><span class="crayon-o">|</span><span class="crayon-r">grep</span><span class="crayon-o">-</span><span class="crayon-i">q</span><span class="crayon-s">" on $TARGET type "</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-86"><span class="crayon-st">if</span><span class="crayon-sy">[</span><span class="crayon-sy">$</span><span class="crayon-sy">?</span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-87"><span class="crayon-st">then</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-88"><span class="crayon-v">SIZE</span><span class="crayon-o">=</span><span class="crayon-sy">`</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">cat</span><span class="crayon-o">/</span><span class="crayon-v">proc</span><span class="crayon-o">/</span><span class="crayon-v">meminfo</span><span class="crayon-o">|</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">grep</span><span class="crayon-s">"^MemTotal"</span><span class="crayon-o">|</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">awk</span><span class="crayon-s">'{print $2}'</span><span class="crayon-sy">`</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-89"><span class="crayon-st">else</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-90"><span class="crayon-v">SIZE</span><span class="crayon-o">=</span><span class="crayon-v">$DEFAULTSIZE</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-91"><span class="crayon-v">TARGET</span><span class="crayon-o">=</span><span class="crayon-s">"/"</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-95"><span class="crayon-c"># OK, time to get down to business.</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-96"><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-r">dd</span><span class="crayon-st">if</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">dev</span><span class="crayon-o">/</span><span class="crayon-e">zero </span><span class="crayon-v">of</span><span class="crayon-o">=</span><span class="crayon-v">$TARGET</span><span class="crayon-o">/</span><span class="crayon-e">swapfile00 </span><span class="crayon-v">bs</span><span class="crayon-o">=</span><span class="crayon-cn">1024</span><span class="crayon-v">count</span><span class="crayon-o">=</span><span class="crayon-v">$SIZE</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-97"><span class="crayon-o">/</span><span class="crayon-v">sbin</span><span class="crayon-o">/</span><span class="crayon-i">mkswap</span><span class="crayon-v">$TARGET</span><span class="crayon-o">/</span><span class="crayon-v">swapfile00</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-98"><span class="crayon-o">/</span><span class="crayon-v">sbin</span><span class="crayon-o">/</span><span class="crayon-i">swapon</span><span class="crayon-v">$TARGET</span><span class="crayon-o">/</span><span class="crayon-i">swapfile00</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-101"><span class="crayon-e">stop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-102"><span class="crayon-r">exit</span><span class="crayon-cn">0</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-105"><span class="crayon-st">case</span><span class="crayon-s">"$1"</span><span class="crayon-st">in</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-106"><span class="crayon-v">start</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-109"><span class="crayon-v">stop</span><span class="crayon-sy">)</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-113"><span class="crayon-r">echo</span><span class="crayon-sy">$</span><span class="crayon-s">"Usage: $0 {start|stop}"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-114"><span class="crayon-r">exit</span><span class="crayon-cn">2</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec2088201689-115"><span class="crayon-st">esac</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec2088201689-116"><span class="crayon-r">exit</span><span class="crayon-sy">$</span><span class="crayon-sy">?</span></p></div></td>
					</tr>
				</table>
			</div>
		</div>


<h3>The DeployWorkstation Play</h3>
<p>Now, we&#x2019;ll create a play that calls these tasks in the right order to provision our workstation and configure it. &#xA0;This file will be created in the root of your playbook, and I named it deployworkstation.yml.</p>

		<div id="crayon-56a7ce17a9ec8390518065" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate">
		
			<p class="crayon-toolbar"><span class="crayon-title">The Deploy Workstation Play</span>
			</p>
			
			
			<div class="crayon-main">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums ">
					
				</td>
						<td class="crayon-code"><div class="crayon-pre"><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-1"><span class="crayon-o">---</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-2"><span class="crayon-c"># deployworkstation.yml</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-3"><span class="crayon-s ">- hosts</span><span class="">: localhost</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-4"><span class="crayon-s ">connection</span><span class="">: local</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-5"><span class="crayon-s ">gather_facts</span><span class="">: no</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-6"><span class="crayon-s ">roles</span><span class="">:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-7"><span class="crayon-s ">- role</span><span class="">: launch</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-8"><span class="crayon-s ">name</span><span class="">: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>group<span class="crayon-sy">_</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span>amibuild<span class="crayon-i ">"</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-10"><span class="crayon-i ">&#xA0;&#xA0;- hosts: "</span><span class="crayon-o">{</span><span class="crayon-o">{</span>group<span class="crayon-sy">_</span>name<span class="crayon-o">}</span><span class="crayon-o">}</span>amibuild"</p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-11"><span class="crayon-s ">become</span><span class="">: True</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-12"><span class="crayon-s ">become_user</span><span class="">: root</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-13"><span class="crayon-s ">become_method</span><span class="">: sudo</span></p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-14"><span class="crayon-s ">roles</span><span class="">:</span></p><p class="crayon-line" id="crayon-56a7ce17a9ec8390518065-15">-yaegashi<span class="crayon-o">.</span>blockinfile</p><p class="crayon-line crayon-striped-line" id="crayon-56a7ce17a9ec8390518065-16">-workstation</p></div></td>
					</tr>
				</table>
			</div>
		</div>


<h3>Testing our&#xA0;Playbook</h3>
<p>To test our work so far, we simply need to execute it with Ansible and see if we are successful:<br>
<code>ansible-playbook -vv -e group_name=test deployworkstation.yml</code><br>
You should see some output at the end of the playbook run like this:<br>
<a href="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.16.05-PM.png" rel="attachment wp-att-182"><img class="alignnone wp-image-182 size-large" src="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.16.05-PM-300x26.png%20300w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.16.05-PM-768x67.png%20768w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.16.05-PM-1024x89.png%201024w" alt="Screen Shot 2016-01-22 at 10.16.05 PM" width="650"></a></p>
<p>Next, connect to your instance with ssh by typing the following command:<br>
<code>ssh ubuntu@ec2-52-90-220-60.compute-1.amazonaws.com</code><br>
(hint: copy/paste the hostname above)</p>
<p>You should see something like the following after you connect with ssh:<br>
<a href="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.17.01-PM.png" rel="attachment wp-att-183"><img class="alignnone wp-image-183 size-large" src="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.17.01-PM-300x187.png%20300w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.17.01-PM-768x478.png%20768w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.17.01-PM-1024x637.png%201024w" alt="Screen Shot 2016-01-22 at 10.17.01 PM" width="650"></a></p>
<p>That&#x2019;s it! &#xA0;You&#x2019;ve now created a workstation in the Amazon public cloud. &#xA0;Be sure to terminate the instance you&#x2019;ve created so that you don&#x2019;t incur any unexpected fees. &#xA0;You can do this by navigating to the EC2 (top left) dashboard from the AWS console, then selecting any running instances and choosing to terminate them:<br>
<a href="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.32-PM.png" rel="attachment wp-att-184"><img class="alignnone wp-image-184 size-large" src="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.32-PM-300x100.png%20300w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.32-PM-768x256.png%20768w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.32-PM-1024x341.png%201024w" alt="Screen Shot 2016-01-22 at 10.18.32 PM" width="650"></a></p>
<p>After selecting to Terminate them from the Instance State menu, you&#x2019;ll need to confirm it:<br>
<a href="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.52-PM.png" rel="attachment wp-att-185"><img class="alignnone wp-image-185 size-large" src="http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.52-PM-300x132.png%20300w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.52-PM-768x339.png%20768w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.52-PM-1024x452.png%201024w,%20http://vcdxpert.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-22-at-10.18.52-PM.png%201532w" alt="Screen Shot 2016-01-22 at 10.18.52 PM" width="650"></a></p>
<p>Now that you&#x2019;ve terminated any running instances, in the next part, we&#x2019;ll learn how to create snapshots, launch configurations, and auto-scaling groups from our immutable golden master images.</p>
			</div>

	
</div>
</body></html>
