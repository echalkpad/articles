<!DOCTYPE html><html><head><title>Build a WhatsApp clone with Meteor and Ionic - Meteor Platform version</title></head><body>
<h1>Build a WhatsApp clone with Meteor and Ionic - Meteor Platform version</h1><p><a href="http://info.meteor.com/blog/whatsapp-with-meteor-angular-and-ionic" target="_new">Original URL</a></p>
<p><blockquote>Now that Angular is a first class citizen in Meteor, you can use all of its vast libraries, giving you full access to the Angular ecosystem.&#xA0;Also,&#xA0;Ionic recently added official support for&hellip;</blockquote></p>
<div><div id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text"><p><img src="http://cdn2.hubspot.net/hub/520701/hubfs/blog_header_images_2.png?t=1445014944449&amp;width=630&amp;height=236" title="" width="630"></p>

<p>Now that Angular is a <a href="http://info.meteor.com/blog/official-angular-support-with-angular-meteor-1.0.0"><span>first class citizen in Meteor</span></a>, you can use all of its vast libraries, giving you full access to the Angular ecosystem.&#xA0;Also,&#xA0;<a href="https://github.com/driftyco/ionic/pull/3133"><span>Ionic recently added official support for Meteor&#x2019;s packaging system</span></a>, and now their package is available on <a href="https://atmospherejs.com/driftyco/ionic"><span>atmosphere</span></a>.</p>
<p>In this tutorial, we will build a WhatsApp clone using Meteor, Angular, and the Ionic Framework for CSS and mobile components.&#xA0;I&#x2019;ve also released a <a href="http://blog.ionic.io/ionic-and-meteor">clone of this tutorial on the Ionic Blog</a> that uses&#xA0;the Ionic CLI instead of the Meteor build system.</p>
<p>It&#x2019;s a good resource for people who wants to use Meteor for their backend and Meteor&#x2019;s client side libraries in a separate front end application, also a good migration strategy.</p>
<p>If you are using Blaze, you can still use Ionic&#x2019;s CSS libraries or the <a href="https://atmospherejs.com/meteoric/ionic"><span>Meteoric package</span></a>.</p>
<p><br>Contents:</p>
<ol>
<li><strong><strong>Installing the platform and creating a base app</strong></strong></li>
<li><strong>WhatsApp views with static data</strong></li>
<li><strong>Create the server and share data with the client</strong></li>
<li><strong>Chat view and send messages</strong></li>
<li><strong><strong>Users and (SMS) authentication</strong></strong></li>
<li><strong><strong>Create and remove chats</strong></strong></li>
<li><strong>Privacy and publish/subscribe</strong></li>
<li><strong>Step 8 - User profile picture</strong></li>
<li><strong>Send image messages</strong></li>
</ol>
<p><br><strong><span>Step 1 - Installing the platform and creating a base app</span></strong></p>
<p>Start by <a href="https://www.meteor.com/install"><span>installing the Meteor platform in this link</span></a>.</p>
<p>Create a new project by running this commands in your Terminal:</p>
<p><code>$ meteor create whatsapp</code></p>
<p><code>$ cd whatsapp</code></p>
<p>Your app now contains a live and ready example app. let&#x2019;s delete those files:</p>
<p><code>$ rm whatsapp.*</code></p>
<p>To run our app simple type `meteor` on the command line:</p>
<p><code>$ meteor</code></p>
<p>We can also run our app inside the iOS Simulator or Android Emulator - we just need to add the platform so Meteor will build the project for the new platform.</p>
<p><code>$ meteor add-platform ios</code></p>

<p><code>$ meteor add-platform android</code></p>
<p><br>And now to run our project in a mobile environment, we just need to tell Meteor which platform we want to run (running the mobile is an addition to the server and client run):</p>
<p><code>$ meteor run ios</code></p>

<p><code>$ meteor run android</code></p>
<p><br>You can find more information about Meteor CLI and build tool here:</p>
<p><a href="https://www.meteor.com/tool"><span>https://www.meteor.com/tool</span></a></p>
<p><br>Our next step is to add the Angular and Ionic packages to the project:</p>
<p><code>$ meteor add angular</code></p>
<p><code>$ meteor add driftyco:ionic</code></p>
<p><br><strong>If you&#x2019;re familiar with the Meteor folder structure and AngularJS module initialization, you can go ahead and skip to the end of this step and just download the ZIP file.</strong><br>We will start by creating the project&#x2019;s folder structure, Meteor has a special behavior for&#xA0;certain folders:</p>
<ul>
<li>client - these files will be available only in the client side.</li>
<li>server - these files will be available only in the server side.</li>
<li>public - these files will be available in the client, uses for assets, images, fonts, etc.</li>
<li>lib - any folder named lib (in any hierarchy) will be loaded first!</li>
<li>any other folder name will be included in both client and server and uses for code-sharing.</li>
</ul>
<p><br>So this will be our folder structure to the project:</p>
<ul>
<li>client (client side with AngularJS and Ionic code)</li>
<ul>
<li>scripts</li>
<li>templates</li>
<li>styles</li>
<li>index.html</li>
</ul>
<li>server (server side code only)</li>
<li>public (assets, images)</li>
<li>lib (define methods and collections in order to make them available in both client and server)</li>
</ul>
<p><br>So let&#x2019;s start by creating our first file - the <code>index.html</code>&#xA0;file - we will place in under the <code>client</code>&#xA0;folder:</p>
<div><strong>1.2</strong>&#xA0; Create index.html <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/ffc46c31aceffe9a3afc4cbea3827f62949d4fb3"> client/index.html &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">head</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">meta</span> <span class="">charset</span>=<span class="">"utf-8"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">meta</span> <span class="">name</span>=<span class="">"viewport"</span> <span class="">content</span>=<span class="">"initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">title</span>&gt;</span>Whatsapp Meteor<span class="">&lt;/<span class="">title</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">head</span>&gt;</span></pre>

<pre class=""><span class="">&lt;<span class="">body</span>&gt;</span></pre>
<pre class=""><span class="">&lt;!--</span></pre>
<pre class=""> The nav bar that will be updated as we navigate between views.</pre>
<pre class="">--&gt;</pre>
<pre class=""><span class="">&lt;<span class="">ion-nav-bar</span> <span class="">class</span>=<span class="">"bar-stable"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-back-button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-back-button</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-nav-bar</span>&gt;</span></pre>
<pre class=""><span class="">&lt;!--</span></pre>
<pre class=""> The views will be rendered in the <span class="">&lt;<span class="">ion-nav-view</span>&gt;</span> directive below</pre>
<pre class=""> Templates are in the /templates folder (but you could also</pre>
<pre class=""> have templates inline in this html file if you'd like).</pre>
<pre class="">--&gt;</pre>
<pre class=""><span class="">&lt;<span class="">ion-nav-view</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>

<pre class=""><span class="">&lt;/<span class="">body</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>We used some ionic tags to achieve mobile style:</p>
<ul>
<li>ion-nav-bar - Create a navigation bar in the page header.</li>
<li>ion-nav-view - This is a placeholder to the real content - AngularJS and ionic will put your content inside this tag automatically.</li>
</ul>
<p><br>Note that we only provide the <code>head</code>&#xA0;and <code>body</code>&#xA0;tags because Meteor takes care of the full&#xA0;contents of the HTML file, and any tag we will use here will be added to the Meteor&#x2019;s main index.html file.</p>
<p>This feature is really useful because we do not need to take care of including our files in <code>index.html</code>&#xA0;and keep it updated ourselves.</p>
<p>Our next step is to create the AngularJS module and bootstrap it according to our platform. <br>We will create a new file called <code>app.ng.js</code>.</p>
<p>We will add the <code>.ng</code>&#xA0;extension to any file the contains AngularJS code in order to help <a href="http://angular-meteor.com/" target="_blank">angular-meteor</a>&#xA0;recognize these files as relevant for AngularJS code.</p>
<p>This bootstrap file should be loaded first, because any other AngularJS code will depend on the module, so we need to put this file inside a folder called <code>lib</code>, so we will create a&#xA0;file in this path: <code>client/scripts/lib/app.ng.js</code>.</p>
<p>This file will contain an AngularJS module initialization with dependencies for <code>angular-meteor</code>&#xA0;and <code>ionic</code>.</p>
<p>We will also check for the current platform (browser or mobile) and initialize the module according to the result:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>, [</pre>
<pre class=""> <span class="">'angular-meteor'</span>,</pre>
<pre class=""> <span class="">'ionic'</span></pre>
<pre class=""> ]);</pre>

<pre class=""><span class="hljs-keyword">if</span> (Meteor.isCordova) {</pre>
<pre class=""> angular.element(<span class="hljs-built_in">document</span>).on(<span class="">'deviceready'</span>, onReady);</pre>
<pre class="">}</pre>
<pre class=""><span class="hljs-keyword">else</span> {</pre>
<pre class=""> angular.element(<span class="hljs-built_in">document</span>).ready(onReady);</pre>
<pre class="">}</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">onReady</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> angular.bootstrap(<span class="hljs-built_in">document</span>, [<span class="">'Whatsapp'</span>]);</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Our next step is to create the states and routes for the views.</p>
<p>Our app uses Ionic to create 5 tabs: Favorites, Recents, Contacts, Chats, and Settings.</p>
<p>We will define our routes and states with <a href="https://atmospherejs.com/angularui/angular-ui-router">angular-ui-router</a>&#xA0;(which is included by ionic), and for the moment we will add the main page which is the <code>chats</code>&#xA0;tab:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .config(config);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">config</span><span class="hljs-params">($stateProvider, $urlRouterProvider)</span> </span>{</pre>
<pre class=""> $stateProvider</pre>
<pre class=""> .state(<span class="">'tab'</span>, {</pre>
<pre class=""> url: <span class="">'/tab'</span>,</pre>
<pre class=""> abstract: <span class="hljs-literal">true</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/tabs.ng.html'</span></pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'tab.chats'</span>, {</pre>
<pre class=""> url: <span class="">'/chats'</span>,</pre>
<pre class=""> views: {</pre>
<pre class=""> <span class="">'tab-chats'</span>: {</pre>
<pre class=""> templateUrl: <span class="">'client/templates/chats.ng.html'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> $urlRouterProvider.otherwise(<span class="">'tab/chats'</span>);</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And this is the HTML template for the footer that included with the tabs view:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-tabs</span> <span class="">class</span>=<span class="">"tabs-stable tabs-icon-top tabs-color-positive"</span> <span class="">ng-cloak</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-tab</span> <span class="">title</span>=<span class="">"Favorites"</span> <span class="">icon-on</span>=<span class="">"ion-ios-star"</span> <span class="">icon-off</span>=<span class="">"ion-ios-star-outline"</span> <span class="">href</span>=<span class="">"#/tab/favorites"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-view</span> <span class="">name</span>=<span class="">"tab-favorites"</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-tab</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-tab</span> <span class="">title</span>=<span class="">"Recents"</span> <span class="">icon-on</span>=<span class="">"ion-ios-clock"</span> <span class="">icon-off</span>=<span class="">"ion-ios-clock-outline"</span> <span class="">href</span>=<span class="">"#/tab/recents"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-view</span> <span class="">name</span>=<span class="">"tab-recents"</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-tab</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-tab</span> <span class="">title</span>=<span class="">"Contacts"</span> <span class="">icon-on</span>=<span class="">"ion-ios-person"</span> <span class="">icon-off</span>=<span class="">"ion-ios-person-outline"</span> <span class="">href</span>=<span class="">"#/tab/contacts"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-view</span> <span class="">name</span>=<span class="">"tab-contacts"</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-tab</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-tab</span> <span class="">title</span>=<span class="">"Chats"</span> <span class="">icon-on</span>=<span class="">"ion-ios-chatbubble"</span> <span class="">icon-off</span>=<span class="">"ion-ios-chatbubble-outline"</span> <span class="">href</span>=<span class="">"#/tab/chats"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-view</span> <span class="">name</span>=<span class="">"tab-chats"</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-tab</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-tab</span> <span class="">title</span>=<span class="">"Settings"</span> <span class="">icon-on</span>=<span class="">"ion-ios-cog"</span> <span class="">icon-off</span>=<span class="">"ion-ios-cog-outline"</span> <span class="">href</span>=<span class="">"#/tab/settings"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-view</span> <span class="">name</span>=<span class="">"tab-settings"</span>&gt;</span><span class="">&lt;/<span class="">ion-nav-view</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-tab</span>&gt;</span></pre>

<pre class=""><span class="">&lt;/<span class="">ion-tabs</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>Create the stub for the main page - the chats file:</p>
<div><strong>1.6</strong>&#xA0; Create basic view for the chats list <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/dc1c67877a0a3a0730cf685f2aa6aeefb665ca32"> client/templates/chats.ng.html &#xBB; </a></div>
<div>
<div>

<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">view-title</span>=<span class="">"Chats"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And this is what&#xA0;it looks at the moment, inside a browser:</p>
<p><img src="http://cdn2.hubspot.net/hub/520701/hubfs/1_-_empty_screen.png?t=1445014944449&amp;width=630&amp;height=311" title="" width="630"></p><p>If you want to view your app in a better way, with mobile layout, you can add a mobile platform as we described in the beginning of the step. I&#x2019;ve added the iOS platform, and when we can run it inside a mobile emulator, and it looks like this:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/2_-_empty_screen_in_emulator.png?t=1445014944449" title=""></p><p><strong>You can download the end result of this step as ZIP file from </strong><a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/38d72ea93e90b39929aae7f568bc4179f66079af.zip"><strong><span>here</span></strong></a><strong>.</strong></p><p><strong><span>Step 2 - WhatsApp views with static data</span></strong></p>
<p>Our next step includes creating basic views with some static data using ionic and SASS.</p>
<p>First, let&#x2019;s create an AngularJS controller that we will later connect to the chats view, we will call it <code>ChatsCtrl</code>&#xA0;and create a new&#xA0;file:</p>
<div><strong>1.8</strong>&#xA0; Create ChatsCtrl <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/ffd790cd42522f6fa41b5737df942194e3e725be"> client/scripts/controllers/chats.controller.ng.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatsCtrl'</span>, ChatsCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatsCtrl</span> <span class="hljs-params">($scope)</span> </span>{</pre>

<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Now we want to add some static data to this controller, we will use <code>moment</code>&#xA0;package to easily create time object, so let&#x2019;s add it to the project using this command:</p>
<p><code>$ meteor add momentjs:moment</code></p>
<p><br>Now let&#x2019;s add the static data, we will create a stub schema for chats and messages:</p>

<div>
<div>
<div>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
</div>
<div>
<pre class=""> .controller(<span class="">'ChatsCtrl'</span>, ChatsCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatsCtrl</span> <span class="hljs-params">($scope)</span> </span>{</pre>

<pre class=""> $scope.chats = [</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">0</span>,</pre>
<pre class=""> name: <span class="">'Ethan Gonzalez'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'You on your way?'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">1</span>,</pre>
<pre class=""> name: <span class="">'Bryan Wallace'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/lego/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'Hey, it\'s me'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">2</span>,</pre>
<pre class=""> name: <span class="">'Avery Stewart'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'I should buy a boat'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">3</span>,</pre>
<pre class=""> name: <span class="">'Katie Peterson'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/2.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'Look at my mukluks!'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">4</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">4</span>,</pre>
<pre class=""> name: <span class="">'Ray Edwards'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/2.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'This is wicked good ice cream.'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'weeks'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Connect the chats view to the <code>ChatsCtrl</code>:</p>

<div>
<div>

<div>
<pre class=""> url: <span class="">'/chats'</span>,</pre>
<pre class=""> views: {</pre>
<pre class=""> <span class="">'tab-chats'</span>: {</pre>
<pre class=""> templateUrl: <span class="">'client/templates/chats.ng.html'</span></pre>
<pre class=""> templateUrl: <span class="">'client/templates/chats.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'ChatsCtrl'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>
</div>
</div>
</div>
<p><br>Modify the chats list view to use the stub data.</p>
<p>We will use ionic&#x2019;s tags to create a container with a list view (<code>ion-list</code>&#xA0;and <code>ion-item</code>), and add <code>ng-repeat</code>&#xA0;to iterate over the chats:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">view-title</span>=<span class="">"Chats"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-item</span></span></pre>
<pre class=""> ng-repeat="chat in chats | orderBy:'-lastMessage.timestamp'"</pre>
<pre class=""> class="item-chat item-remove-animate item-avatar item-icon-right"</pre>
<pre class=""> type="item-text-wrap"&gt;</pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-item</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And this is how is looks like:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/3_-_fake_data_no_date_format.png?t=1445014944449" title=""><br> </p><p>You might notice that the dates are not formatted, so let&#x2019;s create a simple AngularJS filter that use `moment` package to convert the date into formatted text, we will place it in a file named `client/scripts/filters/calendar.filter.ng.js`:</p>
<div><strong>1.13</strong>&#xA0; Create calendar filter <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/1ec068d61884885f4df1e767af9603e58d984efa"> client/scripts/filters/calendar.filter.ng.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .filter(<span class="">'calendar'</span>, calendar);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">calendar</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(time)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! time) <span class="hljs-keyword">return</span>;</pre>

<pre class=""> <span class="hljs-keyword">return</span> moment(time).calendar(<span class="hljs-literal">null</span>, {</pre>
<pre class=""> lastDay : <span class="">'[Yesterday]'</span>,</pre>
<pre class=""> sameDay : <span class="">'LT'</span>,</pre>
<pre class=""> lastWeek : <span class="">'dddd'</span>,</pre>
<pre class=""> sameElse : <span class="">'DD/MM/YY'</span></pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And let&#x2019;s use it in our view:</p>

<div>
<div>

<div>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-item</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-list</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And this how it looks like now:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/4_-_fake_data_with_date_format.png?t=1445014944449" title=""></p><p>To add a delete button to our view, we will use <code>ion-option-button</code>&#xA0;which is a button that&#x2019;s visible when we swipe over the list item!</p>

<div>
<div>
<div>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
</div>
<div>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-option-button</span> <span class="">class</span>=<span class="">"button-assertive"</span> <span class="">ng-click</span>=<span class="">"remove(chat)"</span>&gt;</span></pre>
<pre class=""> Delete</pre>
<pre class=""> <span class="">&lt;/<span class="">ion-option-button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-item</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>Implement the <code>remove(chat)</code>&#xA0;method inside our ChatsCtrl:</p>

<div>
<div>
<div>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
<pre>58</pre>
<pre>59</pre>
<pre>60</pre>
<pre>61</pre>
</div>
<div>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>

<pre class=""> $scope.remove = remove;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">remove</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> $scope.chats.splice($scope.chats.indexOf(chat), <span class="hljs-number">1</span>);</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And this is the result:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/5_-_fake_data_with_delete_button.png?t=1445014944449" title=""></p><p>Now we want to add some styles and make some small CSS modifications to make it look more like WhatsApp.</p>
<p>We want to use SASS in our project, so we need to add the sass package to our project:</p>
<p><code>$ meteor add momentjs:moment</code></p>
<p><br>And now we will create our first SASS file, we will place it under `client/styles/chats.scss`, and add some CSS rules:</p>

<div>
<div>

<div>
<pre class="">.item-chat {</pre>
<pre class=""> .last-message-timestamp {</pre>
<pre class=""> position: absolute;</pre>
<pre class=""> top: 16px;</pre>
<pre class=""> right: 38px;</pre>
<pre class=""> font-size: 14px;</pre>
<pre class=""> color: #9A9898;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And we are done with this view! It look just like WhatsApp!<br> <br><img src="http://cdn2.hubspot.net/hubfs/520701/6_-_fake_data_final_design.png?t=1445014944449" title=""><br> <br> <br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/5091e7e89eb23f9a98badb30011b234b240ecfaa.zip"><span>here</span></a>.<br> <br><strong><span>Step 3 - Create the server and share data with the client</span></strong></p>
<p>In this step we are going to add several features to our project:</p>
<ul>
<li>Create and server and move the static data to the server.</li>
<li>Connect the client to the server.</li>
</ul>
<p><br>So let&#x2019;s start by creating the Meteor collection that will later store all of our data.</p>
<p>Meteor collection need to be available in both client and server in order to share data - so we will create the collections definition in a folder named <code>lib</code>&#xA0;under the project&#x2019;s root (`lib/collections.js`).</p>

<div>
<div>

<div>
<pre class="">Chats = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="">'chats'</span>);</pre>
<pre class="">Messages = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="">'messages'</span>);</pre>
</div>
</div>
</div>
<p><br>Now we need to create our server&#x2019;s first file, so let&#x2019;s create a directory named <code>server</code>&#xA0;and create the server startup file named <code>bootstrap.js</code>&#xA0;(`server/bootstrap.js`).</p>
<p>This file should be run first because we want to run some initialization code there, so we can use `Meteor.startup` to define our logic:</p>
<div><strong>2.2</strong>&#xA0; Create the server's bootstrap file <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/fc43d71f886848617fd3a817df99f28e3c69100f"> server/bootstrap.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">Meteor.startup(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>

<pre class="">});</pre>
</div>
</div>
</div>
<p><br>Our next step is to move the static data to the server, so let&#x2019;s add it in the <code>bootstrap.js</code>&#xA0;file we just created, we also want this code to run only once - when there is no data at all inside the collections.</p>
<div><strong>2.3</strong>&#xA0; Add the stub data to the server <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/f6ab03fb363c07a7d168cd029897b96e3c6dc26a"> server/bootstrap.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
<pre>58</pre>
<pre>59</pre>
<pre>60</pre>
<pre>61</pre>
<pre>62</pre>
</div>
<div>
<pre class="">Meteor.startup(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (Chats.find().count() === <span class="hljs-number">0</span>) {</pre>
<pre class=""> Messages.remove({});</pre>

<pre class=""> <span class="hljs-keyword">var</span> messages = [</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'You on your way?'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'Hey, it\'s me'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'I should buy a boat'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'Look at my mukluks!'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">4</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'This is wicked good ice cream.'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'weeks'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>

<pre class=""> messages.forEach(m =&gt; {</pre>
<pre class=""> Messages.insert(m);</pre>
<pre class=""> });</pre>

<pre class=""> <span class="hljs-keyword">var</span> chats = [</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Ethan Gonzalez'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Bryan Wallace'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/lego/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Avery Stewart'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Katie Peterson'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/2.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Ray Edwards'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/2.jpg'</span></pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>

<pre class=""> chats.forEach(chat =&gt; {</pre>
<pre class=""> <span class="hljs-keyword">let</span> message = Messages.findOne({chatId: {$exists: <span class="hljs-literal">false</span>}});</pre>
<pre class=""> chat.lastMessage = message;</pre>
<pre class=""> <span class="hljs-keyword">let</span> chatId = Chats.insert(chat);</pre>
<pre class=""> Messages.update(message._id, {$set: {chatId: chatId}})</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>Now we need to remove the static data from the client and get it from the server.</p>
<p>So let&#x2019;s use angular-meteor&#x2019;s API for this - we just need to wrap our collection object with <a href="http://angular-meteor.com/api/meteorCollection" target="_blank">$meteorCollection</a> and we the data is synced:</p>

<div>
<div>

<div>
<pre class=""> .controller(<span class="">'ChatsCtrl'</span>, ChatsCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatsCtrl</span> <span class="hljs-params">($scope)</span> </span>{</pre>
<pre class=""> $scope.chats = [</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">0</span>,</pre>
<pre class=""> name: <span class="">'Ethan Gonzalez'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'You on your way?'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">1</span>,</pre>
<pre class=""> name: <span class="">'Bryan Wallace'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/lego/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'Hey, it\'s me'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">2</span>,</pre>
<pre class=""> name: <span class="">'Avery Stewart'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/1.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'I should buy a boat'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">3</span>,</pre>
<pre class=""> name: <span class="">'Katie Peterson'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/2.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'Look at my mukluks!'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">4</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> _id: <span class="hljs-number">4</span>,</pre>
<pre class=""> name: <span class="">'Ray Edwards'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/2.jpg'</span>,</pre>
<pre class=""> lastMessage: {</pre>
<pre class=""> text: <span class="">'This is wicked good ice cream.'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'weeks'</span>).toDate()</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>

<pre class=""> $scope.chats = $scope.$meteorCollection(Chats, <span class="hljs-literal">false</span>);</pre>
<pre class=""> $scope.remove = remove;</pre>

<pre class=""> <span class="">////////////</span></pre>
</div>
</div>
</div>
<p><br>Now that the data comes from the server, we need to modify the <code>remove</code>&#xA0;method in order to use $meteorCollection API that removes the object from both client and server:</p>

<div>
<div>

<div>
<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">remove</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> $scope.chats.splice($scope.chats.indexOf(chat), <span class="hljs-number">1</span>);</pre>
<pre class=""> $scope.chats.remove(chat);</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/ebd3254cab8f46c435540f5876b8322cac1fce7c.zip"><span>here</span></a>.<br> <br><strong><span>Step 4 - Chat view and send messages</span></strong></p>
<p>In this step we will add the chat view and the ability to send messages.</p>
<p>We still won&#x2019;t have an identity for each user - we will add it later, but we can still send messages to existing chats.</p>
<p><br>So just like any other page, first we need to add a route and a state.</p>
<p>Let&#x2019;s call it <code>chat-details</code>&#xA0;and we will load a template and a controller which we will add later.</p>

<div>
<div>
<div>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
</div>
<div>
<pre class=""> controller: <span class="">'ChatsCtrl'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'tab.chat-detail'</span>, {</pre>
<pre class=""> url: <span class="">'/chats/:chatId'</span>,</pre>
<pre class=""> views: {</pre>
<pre class=""> <span class="">'tab-chats'</span>: {</pre>
<pre class=""> templateUrl: <span class="">'client/templates/chat-detail.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'ChatDetailCtrl'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> $urlRouterProvider.otherwise(<span class="">'tab/chats'</span>);</pre>
</div>
</div>
</div>
<p><br>Let&#x2019;s add a very basic view with the chat&#x2019;s details - the file will located in `client/templates/chat-detail.ng.html`:</p>

<div>
<div>

<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear"</span>&gt;</span><span class="">&lt;<span class="">img</span> <span class="">class</span>=<span class="">"header-picture"</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>Now we need to implement the logic in the controller, so let&#x2019;s create it in `client/scripts/controllers/chat-detail.controller.ng.js` and call it ChatDetailCtrl.</p>
<p>We will use the $stateParams to get the chat id and then we will use angular-meteor&#x2019;s <a href="http://angular-meteor.com/api/meteorObject" target="_blank">$meteorObject</a> to create a reactive object:</p>

<div>
<div>

<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatDetailCtrl'</span>, ChatDetailCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chatId = $stateParams.chatId;</pre>
<pre class=""> $scope.chat = $scope.$meteorObject(Chats, chatId, <span class="hljs-literal">false</span>);</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>We use the Chats collection as the first param, the chat id as the second params, and we will use <code>false</code>&#xA0;as the third param so that we will have to explicitly update the object and not autobind the client changes to the server.<br>So now we have the chat details page, all we need to do is to add a link from the chats list to this view:</p>

<div>
<div>

<div>
<pre class=""> <span class="">&lt;<span class="">ion-item</span></span></pre>
<pre class=""> ng-repeat="chat in chats | orderBy:'-lastMessage.timestamp'"</pre>
<pre class=""> class="item-chat item-remove-animate item-avatar item-icon-right"</pre>
<pre class=""> type="item-text-wrap"&gt;</pre>
<pre class=""> type="item-text-wrap"</pre>
<pre class=""> href="#/tab/chats/"&gt;</pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>So this is what we have at the moment, if we click on a chat in the list:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/7_-_Chat_details_with_bad_picture.png?t=1445014944449" title=""></p><p>Now let&#x2019;s add some CSS rules and let&#x2019;s add the messages view!</p>
<p>Let&#x2019;s create a new SASS file for our new view at `client/styles/chat-detail.scss`, and first we will take care of the chat image that look weird:</p>

<div>
<div>

<div>
<pre class="">.header-picture {</pre>
<pre class=""> max-width: 33px;</pre>
<pre class=""> max-height: 33px;</pre>
<pre class=""> width: 100%;</pre>
<pre class=""> height: 100%;</pre>
<pre class=""> border-radius: 50%;</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Our next step is about getting the chat messages on the controller, we will use $meteorCollection again, but instead of using the collection object - we will fetch only the relevant messages for the current chat:</p>

<div>
<div>

<div>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chatId = $stateParams.chatId;</pre>
<pre class=""> $scope.chat = $scope.$meteorObject(Chats, chatId, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $scope.messages = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Messages.find({ chatId: chatId });</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And now to add it to the view, we use <code>ng-repeat</code>&#xA0;to iterate the messages:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear"</span>&gt;</span><span class="">&lt;<span class="">img</span> <span class="">class</span>=<span class="">"header-picture"</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear"</span>&gt;</span><span class="">&lt;<span class="">img</span> <span class="">class</span>=<span class="">"header-picture"</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"chat"</span> <span class="">delegate-handle</span>=<span class="">"chatScroll"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-list"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-repeat</span>=<span class="">"message in messages"</span> <span class="">class</span>=<span class="">"message-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message"</span> <span class="">ng-class-even</span>=<span class="">"'message-mine'"</span> <span class="">ng-class-odd</span>=<span class="">"'message-other'"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>At the moment we do not have identity for each user or message, so we will just use odd/even and this would be the indication for which message is mine and which isn&#x2019;t - in the next step we will add the authentication and each message will be related to a user.<br>Now we will add some CSS to the messages list:</p>

<div>
<div>
<div>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
<pre>58</pre>
<pre>59</pre>
<pre>60</pre>
<pre>61</pre>
<pre>62</pre>
<pre>63</pre>
<pre>64</pre>
<pre>65</pre>
<pre>66</pre>
<pre>67</pre>
<pre>68</pre>
<pre>69</pre>
<pre>70</pre>
<pre>71</pre>
<pre>72</pre>
<pre>73</pre>
<pre>74</pre>
<pre>75</pre>
<pre>76</pre>
<pre>77</pre>
<pre>78</pre>
<pre>79</pre>
<pre>80</pre>
<pre>81</pre>
<pre>82</pre>
<pre>83</pre>
<pre>84</pre>
<pre>85</pre>
<pre>86</pre>
</div>
<div>
<pre class=""> width: 100%;</pre>
<pre class=""> height: 100%;</pre>
<pre class=""> border-radius: 50%;</pre>
<pre class="">}</pre>

<pre class="">.chat {</pre>
<pre class=""> background-image: url(/chat-background.jpg);</pre>
<pre class=""> background-color: #E0DAD6;</pre>
<pre class=""> background-repeat: no-repeat;</pre>
<pre class=""> background-size: 100%;</pre>
<pre class="">}</pre>

<pre class="">.message-list {</pre>
<pre class=""> margin-top: 12px;</pre>
<pre class=""> padding: 0 5%;</pre>
<pre class="">}</pre>

<pre class="">.message-wrapper {</pre>
<pre class=""> margin-bottom: 9px;</pre>

<pre class=""> &amp;::after {</pre>
<pre class=""> content: "";</pre>
<pre class=""> display: table;</pre>
<pre class=""> clear: both;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>

<pre class="">.message {</pre>
<pre class=""> display: inline-block;</pre>
<pre class=""> position: relative;</pre>
<pre class=""> max-width: 236px;</pre>
<pre class=""> border-radius: 7px;</pre>
<pre class=""> box-shadow: 0 1px 2px rgba(0, 0, 0, .15);</pre>

<pre class=""> &amp;.message-mine {</pre>
<pre class=""> float: right;</pre>
<pre class=""> background-color: #DCF8C6;</pre>
<pre class=""> }</pre>

<pre class=""> &amp;.message-other {</pre>
<pre class=""> float: left;</pre>
<pre class=""> background-color: #FFF;</pre>
<pre class=""> }</pre>

<pre class=""> &amp;.message-other::before, &amp;.message-mine::before, {</pre>
<pre class=""> content: "";</pre>
<pre class=""> position: absolute;</pre>
<pre class=""> bottom: 3px;</pre>
<pre class=""> width: 12px;</pre>
<pre class=""> height: 19px;</pre>
<pre class=""> background-position: 50% 50%;</pre>
<pre class=""> background-repeat: no-repeat;</pre>
<pre class=""> background-size: contain;</pre>
<pre class=""> }</pre>

<pre class=""> &amp;.message-other::before {</pre>
<pre class=""> left: -11px;</pre>
<pre class=""> background-image: url(/message-other.png)</pre>
<pre class=""> }</pre>

<pre class=""> &amp;.message-mine::before {</pre>
<pre class=""> right: -11px;</pre>
<pre class=""> background-image: url(/message-mine.png)</pre>
<pre class=""> }</pre>

<pre class=""> .message-text {</pre>
<pre class=""> padding: 5px 7px;</pre>
<pre class=""> word-wrap: break-word;</pre>

<pre class=""> &amp;::after {</pre>
<pre class=""> content: " \00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0";</pre>
<pre class=""> display: inline;</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>

<pre class=""> .message-timestamp {</pre>
<pre class=""> position: absolute;</pre>
<pre class=""> bottom: 2px;</pre>
<pre class=""> right: 7px;</pre>
<pre class=""> color: gray;</pre>
<pre class=""> font-size: 12px;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>We also add the images from the original WhatsApp.</p>
<p>Note that the images are under <code>public/</code>&#xA0;folder so we can use them in the client side from the root directory (in the CSS file).</p>
<p>You can copy them form <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/tree/master/public" target="_blank">here</a>.</p>
<p>And this is the result:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/8_-_Chat_details_without_date_format.png?t=1445014944449" title=""></p><p>Now we just need to take care of the message timestamp and format it.</p>
<p>We will use <code>moment</code>&#xA0;like before, but now let&#x2019;s add another package called <a href="https://github.com/urish/angular-moment" target="_blank">angular-moment</a>&#xA0;that provides us the UI filters.</p>
<p>So adding the package is just like any other package we added so far:</p>
<p><code>$ meteor add jasonaibrahim:angular-moment</code></p>
<p><br>And because it&#x2019;s an AngularJS extension, we need to add a dependency in our module definition:</p>
<div><strong>3.11</strong>&#xA0; Add angularMoment dependency <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/13aae085b4476eea7d10ca4e3551ea67a90eeeb4"> client/scripts/lib/app.ng.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>, [</pre>
<pre class=""> <span class="">'angular-meteor'</span>,</pre>
<pre class=""> <span class="">'ionic'</span></pre>
<pre class=""> <span class="">'ionic'</span>,</pre>
<pre class=""> <span class="">'angularMoment'</span></pre>
<pre class=""> ]);</pre>

<pre class=""><span class="hljs-keyword">if</span> (Meteor.isCordova) {</pre>
</div>
</div>
</div>
<p><br>And now we will use a filter from this package in our view:</p>

<div>
<div>

<div>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-repeat</span>=<span class="">"message in messages"</span> <span class="">class</span>=<span class="">"message-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message"</span> <span class="">ng-class-even</span>=<span class="">"'message-mine'"</span> <span class="">ng-class-odd</span>=<span class="">"'message-other'"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And the result is:<br> <br><img src="http://cdn2.hubspot.net/hubfs/520701/9_-_Chat_details_with_date_format.png?t=1445014944449" title=""></p>
<p>Just like WhatsApp...<br> <br>Our next step is about adding the input for adding a new message to the chat, we need to add an input in the bottom of the view - <code>ion-footer-bar</code>&#xA0;is a perfect solution for that.</p>
<p>So we will add an input, Send button and some icons for sending images and sound recordings (it&#x2019;s just icons at the moment!)</p>

<div>
<div>
<div>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
</div>
<div>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-footer-bar</span> <span class="">keyboard-attach</span> <span class="">class</span>=<span class="">"bar-stable footer-chat item-input-inset"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-upload-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">label</span> <span class="">class</span>=<span class="">"item-input-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">input</span></span></pre>
<pre class=""> ng-model="data.message"</pre>
<pre class=""> dir="auto"</pre>
<pre class=""> type="text"/&gt;</pre>
<pre class=""> <span class="">&lt;/<span class="">label</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">ng-if</span>=<span class="">"data.message.length &gt; 0"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"sendMessage()"</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span>&gt;</span>Send<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">ng-if</span>=<span class="">"!data.message || data.message.length === 0"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-camera-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"buttons-seperator icon ion-android-more-vertical"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-mic-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-footer-bar</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>Let&#x2019;s add the <code>data</code>&#xA0;object to our controller, and add a stub method for <code>sendMessage</code>, we will implement it later.</p>

<div>
<div>
<div>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
</div>
<div>
<pre class=""> $scope.messages = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Messages.find({ chatId: chatId });</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $scope.data = {};</pre>
<pre class=""> $scope.sendMessage = sendMessage;</pre>

<pre class=""> <span class="">///</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">sendMessage</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="">// TODO: Implement this logic</span></pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And this is what we got so far:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/10_-_Chat_details_with_camera_icons.png?t=1445014944449" title=""><br> </p><p>To improve the user experience in our app, we want some extra events to our input because we want to move it up when the keyboard comes from the bottom of the screen and we want to know if <code>return</code>&#xA0;(or Enter) was clicked.</p>
<p>We will implement a new directive that extends the regular <code>input</code>&#xA0;tag and add those events to the directive:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .directive(<span class="">'input'</span>, input);</pre>

<pre class=""><span class="">// The directive enable sending message when tapping return</span></pre>
<pre class=""><span class="">// and expose the focus and blur events to adjust the view</span></pre>
<pre class=""><span class="">// when the keyboard opens and closes</span></pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">input</span> <span class="hljs-params">($timeout)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> directive = {</pre>
<pre class=""> restrict: <span class="">'E'</span>,</pre>
<pre class=""> scope: {</pre>
<pre class=""> <span class="">'returnClose'</span>: <span class="">'='</span>,</pre>
<pre class=""> <span class="">'onReturn'</span>: <span class="">'&amp;'</span>,</pre>
<pre class=""> <span class="">'onFocus'</span>: <span class="">'&amp;'</span>,</pre>
<pre class=""> <span class="">'onBlur'</span>: <span class="">'&amp;'</span></pre>
<pre class=""> },</pre>
<pre class=""> link: link</pre>
<pre class=""> };</pre>
<pre class=""> <span class="hljs-keyword">return</span> directive;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">link</span> <span class="hljs-params">(scope, element, attrs)</span> </span>{</pre>
<pre class=""> element.bind(<span class="">'focus'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (scope.onFocus) {</pre>
<pre class=""> $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> scope.onFocus();</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> element.bind(<span class="">'blur'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (scope.onBlur) {</pre>
<pre class=""> $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> scope.onBlur();</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> element.bind(<span class="">'keydown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (e.which == <span class="hljs-number">13</span>) {</pre>
<pre class=""> <span class="hljs-keyword">if</span> (scope.returnClose) {</pre>
<pre class=""> element[<span class="hljs-number">0</span>].blur();</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">if</span> (scope.onReturn) {</pre>
<pre class=""> $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> scope.onReturn();</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And now we can use those useful events in our view:</p>

<div>
<div>
<div>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
</div>
<div>
<pre class=""> <span class="">&lt;<span class="">label</span> <span class="">class</span>=<span class="">"item-input-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">input</span></span></pre>
<pre class=""> ng-model="data.message"</pre>
<pre class=""> on-return="sendMessage(); closeKeyboard()"</pre>
<pre class=""> on-focus="inputUp()"</pre>
<pre class=""> on-blur="inputDown()"</pre>
<pre class=""> dir="auto"</pre>
<pre class=""> type="text"/&gt;</pre>
<pre class=""> <span class="">&lt;/<span class="">label</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And implement the $scope method that handles those events:</p>

<div>
<div>
<div>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>

<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
</div>
<div>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatDetailCtrl'</span>, ChatDetailCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams)</span> </span>{</pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams, $ionicScrollDelegate, $timeout)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chatId = $stateParams.chatId;</pre>
<pre class=""> <span class="hljs-keyword">var</span> isIOS = ionic.Platform.isWebView() &amp;&amp; ionic.Platform.isIOS();</pre>
<pre class=""> $scope.chat = $scope.$meteorObject(Chats, chatId, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $scope.messages = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""><span class="">...some lines skipped...</span></pre>

<pre class=""> $scope.data = {};</pre>
<pre class=""> $scope.sendMessage = sendMessage;</pre>
<pre class=""> $scope.inputUp = inputUp;</pre>
<pre class=""> $scope.inputDown = inputDown;</pre>
<pre class=""> $scope.closeKeyboard = closeKeyboard;</pre>

<pre class=""> <span class="">///</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">sendMessage</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="">// TODO: Implement this logic</span></pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">inputUp</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (isIOS) {</pre>
<pre class=""> $scope.data.keyboardHeight = <span class="hljs-number">216</span>;</pre>
<pre class=""> }</pre>

<pre class=""> $timeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $ionicScrollDelegate.$getByHandle(<span class="">'chatScroll'</span>).scrollBottom(<span class="hljs-literal">true</span>);</pre>
<pre class=""> }, <span class="hljs-number">300</span>);</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">inputDown</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (isIOS) {</pre>
<pre class=""> $scope.data.keyboardHeight = <span class="hljs-number">0</span>;</pre>
<pre class=""> }</pre>

<pre class=""> $ionicScrollDelegate.$getByHandle(<span class="">'chatScroll'</span>).resize();</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">closeKeyboard</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="">// cordova.plugins.Keyboard.close();</span></pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>We will also add some CSS to this view:</p>

<div>
<div>
<div>
<pre>83</pre>
<pre>84</pre>
<pre>85</pre>
<pre>86</pre>
<pre>87</pre>
<pre>88</pre>
<pre>89</pre>
<pre>90</pre>
<pre>91</pre>
<pre>92</pre>
<pre>93</pre>
<pre>94</pre>
<pre>95</pre>
<pre>96</pre>
<pre>97</pre>
<pre>98</pre>
<pre>99</pre>
<pre>100</pre>
<pre>101</pre>
<pre>102</pre>
</div>
<div>
<pre class=""> color: gray;</pre>
<pre class=""> font-size: 12px;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>

<pre class="">.footer-chat {</pre>
<pre class=""> .item-input-wrapper {</pre>
<pre class=""> background-color: #FFF;</pre>
<pre class=""> }</pre>

<pre class=""> .button.button-icon {</pre>
<pre class=""> margin: 0 10px;</pre>
<pre class=""> }</pre>

<pre class=""> .buttons-seperator {</pre>
<pre class=""> color: gray;</pre>
<pre class=""> font-size: 18px;</pre>
<pre class=""> line-height: 32px;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>So now when the user focuses on the input, it goes up, like that:</p>
<p><br><img src="http://cdn2.hubspot.net/hubfs/520701/11_-_Chat_details_with_keyboard_open.png?t=1445014944449" title=""></p>
<p>So now it&#x2019;s time to implement the <code>sendMessage</code>&#xA0;method in our controller.</p>
<p>We will use <a href="http://angular-meteor.com/api/methods" target="_blank">$meteor.call</a>&#xA0;method to call the Meteor method:</p>

<div>
<div>
<div>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>

<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
</div>
<div>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatDetailCtrl'</span>, ChatDetailCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams, $ionicScrollDelegate, $timeout)</span> </span>{</pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams, $ionicScrollDelegate, $timeout, $meteor)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chatId = $stateParams.chatId;</pre>
<pre class=""> <span class="hljs-keyword">var</span> isIOS = ionic.Platform.isWebView() &amp;&amp; ionic.Platform.isIOS();</pre>
<pre class=""> $scope.chat = $scope.$meteorObject(Chats, chatId, <span class="hljs-literal">false</span>);</pre>
<pre class=""><span class="">...some lines skipped...</span></pre>
<pre class=""> <span class="">///</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">sendMessage</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="">// TODO: Implement this logic</span></pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.message)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> $meteor.call(<span class="">'newMessage'</span>, {</pre>
<pre class=""> text: $scope.data.message,</pre>
<pre class=""> chatId: chatId</pre>
<pre class=""> });</pre>

<pre class=""> <span class="hljs-keyword">delete</span> $scope.data.message;</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">inputUp</span> <span class="hljs-params">()</span> </span>{</pre>
</div>
</div>
</div>
<p><br>Now let&#x2019;s create our Method in `lib/methods.js`:</p>
<div><strong>3.20</strong>&#xA0; Add sendMessage method to the server <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/33e9c397a04dae4ea043883afc0660762fbbe1f1"> lib/methods.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">Meteor.methods({</pre>
<pre class=""> newMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message)</span> </span>{</pre>
<pre class=""> message.timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</pre>

<pre class=""> <span class="hljs-keyword">var</span> messageId = Messages.insert(message);</pre>
<pre class=""> Chats.update(message.chatId, { $set: { lastMessage: message } });</pre>

<pre class=""> <span class="hljs-keyword">return</span> messageId;</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>Let&#x2019;s add validation to our method.</p>
<p>Meteor provides us a useful package named `check` that validates data types and scheme.</p>
<p>Add it by running:</p>
<p><code>$ meteor add check</code></p>
<p>And now let&#x2019;s use it in the <code>newMessage</code>&#xA0;method:</p>
<div><strong>3.22</strong>&#xA0; Add usage of check package to the newMessage method <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/d03d1c909c660903dd52a1cac1d957bf0cf269f1"> lib/methods.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">Meteor.methods({</pre>
<pre class=""> newMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message)</span> </span>{</pre>
<pre class=""> check(message, {</pre>
<pre class=""> text: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> chatId: <span class="hljs-built_in">String</span></pre>
<pre class=""> });</pre>

<pre class=""> message.timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</pre>

<pre class=""> <span class="hljs-keyword">var</span> messageId = Messages.insert(message);</pre>
</div>
</div>
</div>
<p><br>And now we just need to send some messages in our chat!</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/12_-_Chat_details_with_reply.png?t=1445014944449" title=""></p><p>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/d03d1c909c660903dd52a1cac1d957bf0cf269f1.zip"><span>here</span></a>.<br> <br><strong><span>Step 5 - <strong><strong><span>Users and (SMS) authentication</span></strong></strong></span></strong></p>
<p>On this step we will authenticate and identify users in our app.</p>
<p>We will use Meteor&#x2019;s authentication packages, the basic package called Accounts and it has many extensions for Google, Facebook, Phone and many more.</p>
<p>We will use Accounts-phone package that verifies the user using a phone number with SMS messages.</p>
<p>To add this package, run this command:</p>
<p><code>$ meteor add okland:accounts-phone</code></p>

<p>We just need to add some configuration to the server side in order to make it work, so let&#x2019;s create `server/sms.js` and this is his content:</p>
<div><strong>4.2</strong>&#xA0; Add SMS configuration for Accounts-Phone package <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/357eb04681601ed55b400ff8bb0d82c55b9518c0"> server/sms.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class=""><span class="hljs-keyword">if</span> (Meteor.settings &amp;&amp; Meteor.settings.ACCOUNTS_PHONE) {</pre>
<pre class=""> Accounts._options.adminPhoneNumbers = Meteor.settings.ACCOUNTS_PHONE.ADMIN_NUMBERS;</pre>
<pre class=""> Accounts._options.phoneVerificationMasterCode = Meteor.settings.ACCOUNTS_PHONE.MASTER_CODE;</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Let&#x2019;s add configuration is for debug purposes:</p>

<p><code>&#xA0; "<span>TWILIO": {</span></code></p>
<p><code><span>&#xA0; &#xA0; "FROM": "meteor-whatsapp",</span></code></p>
<p><code><span>&#xA0; &#xA0; "SID: "",</span></code></p>
<p><code><span>&#xA0; &#xA0; "TOKEN": ""</span></code></p>

<p><code><span>&#xA0; "ACCOUNTS_PHONE": {</span></code></p>
<p><code><span>&#xA0; &#xA0; "ADMIN_NUMBERS": ["123456789", "987654321"],</span></code></p>
<p><code><span>&#xA0; &#xA0; "MASTER_CODE": "1234",</span></code></p>


<p><br>So these flow is created by 3 new views: login, confirmation and profile.<br>This means we can use the numbers `123456789` and `987654321` and they won&#x2019;t send real SMS message, and then in the confirmation modal, we can always use `1234` and it will work.<br>Now let&#x2019;s create the same flow of WhatsApp for authentication: first we need to ask for the user&#x2019;s phone number, verify it with SMS message and then ask the user to pick his name.</p>
<p>Let&#x2019;s add these states, each with HTML template and controller:</p>

<div>
<div>
<div>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
</div>
<div>
<pre class=""> controller: <span class="">'ChatDetailCtrl'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'login'</span>, {</pre>
<pre class=""> url: <span class="">'/login'</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/login.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'LoginCtrl'</span></pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'confirmation'</span>, {</pre>
<pre class=""> url: <span class="">'/confirmation/:phone'</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/confirmation.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'ConfirmationCtrl'</span></pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'profile'</span>, {</pre>
<pre class=""> url: <span class="">'/profile'</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/profile.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'ProfileCtrl'</span></pre>
<pre class=""> });</pre>

<pre class=""> $urlRouterProvider.otherwise(<span class="">'tab/chats'</span>);</pre>
</div>
</div>
</div>
<p><br>We will now add the view of login state - it includes an input and a save button and later we will add a modal dialog to verify the user&#x2019;s phone:</p>
<div><strong>4.4</strong>&#xA0; Create the login view <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/6079825d4b77e421966dac9124fd01a17d2073f5"> client/templates/login.ng.html &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">"Your phone number"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"login()"</span> <span class="">ng-disabled</span>=<span class="">"!data.phone || data.phone.length === 0"</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span>&gt;</span>Done<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"login"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"text-center instructions"</span>&gt;</span></pre>
<pre class=""> Please confirm your country code and enter your phone number</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"list"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">label</span> <span class="">class</span>=<span class="">"item item-input"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">input</span> <span class="">ng-model</span>=<span class="">"data.phone"</span> <span class="">on-return</span>=<span class="">"login()"</span> <span class="">type</span>=<span class="">"text"</span> <span class="">placeholder</span>=<span class="">"Your phone number"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">label</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And the controller - the logic is simple - we ask the user to check again his phone number, and then we will use Accounts API in order to ask for SMS verification:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'LoginCtrl'</span>, LoginCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">LoginCtrl</span><span class="hljs-params">($scope, $state, $ionicLoading, $ionicPopup, $log)</span> </span>{</pre>
<pre class=""> $scope.data = {};</pre>
<pre class=""> $scope.login = login;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">login</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.phone)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">var</span> confirmPopup = $ionicPopup.confirm({</pre>
<pre class=""> title: <span class="">'Number confirmation'</span>,</pre>
<pre class=""> template: <span class="">'&lt;div&gt;'</span> + $scope.data.phone + <span class="">'&lt;/div&gt;&lt;div&gt;Is your phone number above correct?&lt;/div&gt;'</span>,</pre>
<pre class=""> cssClass: <span class="">'text-center'</span>,</pre>
<pre class=""> okText: <span class="">'Yes'</span>,</pre>
<pre class=""> okType: <span class="">'button-positive button-clear'</span>,</pre>
<pre class=""> cancelText: <span class="">'edit'</span>,</pre>
<pre class=""> cancelType: <span class="">'button-dark button-clear'</span></pre>
<pre class=""> });</pre>

<pre class=""> confirmPopup.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(res)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (!res) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> $ionicLoading.show({</pre>
<pre class=""> template: <span class="">'Sending verification code...'</span></pre>
<pre class=""> });</pre>

<pre class=""> Accounts.requestPhoneVerification($scope.data.phone, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> $ionicLoading.hide();</pre>

<pre class=""> <span class="hljs-keyword">if</span> (err) {</pre>
<pre class=""> <span class="hljs-keyword">return</span> handleError(err);</pre>
<pre class=""> }</pre>

<pre class=""> $state.go(<span class="">'confirmation'</span>, {phone: $scope.data.phone});</pre>
<pre class=""> });</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">handleError</span><span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> $log.error(<span class="">'Login error '</span>, err);</pre>

<pre class=""> $ionicPopup.alert({</pre>
<pre class=""> title: err.reason || <span class="">'Login failed'</span>,</pre>
<pre class=""> template: <span class="">'Please try again'</span>,</pre>
<pre class=""> okType: <span class="">'button-positive button-clear'</span></pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>Note the we did not provide all the settings for Account-Phone - so it will run in debug mode - so real SMS won&#x2019;t be sent now - but to check your app you can see the confirmation in the Meteor&#x2019;s app log.<br>Our next step is limit the current views to logged in users only - we will use angular-meteor&#x2019;s API for that - we will limit the <code>tab</code>&#xA0;and <code>profile</code>&#xA0;states using <code>$meteor.requiredUser()</code>&#xA0;which return a promise that resolves only if the user is logged in:</p>

<div>
<div>
<div>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>

<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
</div>
<div>
<pre class=""> .state(<span class="">'tab'</span>, {</pre>
<pre class=""> url: <span class="">'/tab'</span>,</pre>
<pre class=""> abstract: <span class="hljs-literal">true</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/tabs.ng.html'</span></pre>
<pre class=""> templateUrl: <span class="">'client/templates/tabs.ng.html'</span>,</pre>
<pre class=""> resolve: {</pre>
<pre class=""> user: [<span class="">'$meteor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($meteor)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> $meteor.requireUser();</pre>
<pre class=""> }]</pre>
<pre class=""> }</pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'tab.chats'</span>, {</pre>
<pre class=""> url: <span class="">'/chats'</span>,</pre>
<pre class=""><span class="">...some lines skipped...</span></pre>
<pre class=""> .state(<span class="">'profile'</span>, {</pre>
<pre class=""> url: <span class="">'/profile'</span>,</pre>
<pre class=""> templateUrl: <span class="">'client/templates/profile.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'ProfileCtrl'</span></pre>
<pre class=""> controller: <span class="">'ProfileCtrl'</span>,</pre>
<pre class=""> resolve: {</pre>
<pre class=""> user: [<span class="">'$meteor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($meteor)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> $meteor.requireUser();</pre>
<pre class=""> }]</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> $urlRouterProvider.otherwise(<span class="">'tab/chats'</span>);</pre>
</div>
</div>
</div>
<p><br>And now we want to handle a case that this promise does not resolves (in case that the user is not logged in), so let&#x2019;s create new file - `client/scripts/auth.js` that uses Angular&#x2019;s config phase:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .run(run);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">run</span><span class="hljs-params">($rootScope, $state)</span> </span>{</pre>
<pre class=""> $rootScope.$on(<span class="">'$stateChangeError'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event, toState, toParams, fromState, fromParams, error)</span> </span>{</pre>
<pre class=""> <span class="">// We can catch the error thrown when the $requireUser promise is rejected</span></pre>
<pre class=""> <span class="">// and redirect the user back to the main page</span></pre>
<pre class=""> <span class="hljs-keyword">if</span> (error === <span class="">'AUTH_REQUIRED'</span>) {</pre>
<pre class=""> $state.go(<span class="">'login'</span>);</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And now let&#x2019;s add some CSS:</p>
<div><strong>4.8</strong>&#xA0; Add some CSS for better login view <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/6c6e84ee1d02cd09121582469e1bbcc1a390653d"> client/styles/login.scss &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">.login {</pre>
<pre class=""> .instructions {</pre>
<pre class=""> margin: 50px 0;</pre>
<pre class=""> padding: 0 15px;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And this is how it looks like:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/13_-_Enter_phone_screen.png?t=1445014944449" title=""></p>
<p>The next step is to add the confirmation view, starting with the HTML:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"verify()"</span> <span class="">ng-disabled</span>=<span class="">"!data.code || data.code.length === 0"</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span>&gt;</span>Done<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"text-center padding"</span>&gt;</span></pre>
<pre class=""> We have sent you an SMS with a code to the number above</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"text-center padding"</span>&gt;</span></pre>
<pre class=""> To complete your phone number verification WhatsApp, please enter the 4-digit activation code.</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"list padding-top"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">label</span> <span class="">class</span>=<span class="">"item item-input"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">input</span> <span class="">ng-model</span>=<span class="">"data.code"</span> <span class="">on-return</span>=<span class="">"verify()"</span> <span class="">type</span>=<span class="">"text"</span> <span class="">placeholder</span>=<span class="">"Code"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">label</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And the controller:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ConfirmationCtrl'</span>, ConfirmationCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ConfirmationCtrl</span><span class="hljs-params">($scope, $state, $ionicPopup, $log)</span> </span>{</pre>
<pre class=""> $scope.phone = $state.params.phone;</pre>
<pre class=""> $scope.data = {};</pre>
<pre class=""> $scope.verify = verify;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">verify</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.code)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> Accounts.verifyPhone($scope.phone, $scope.data.code, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (err) {</pre>
<pre class=""> <span class="hljs-keyword">return</span> handleError(err);</pre>
<pre class=""> }</pre>

<pre class=""> $state.go(<span class="">'profile'</span>);</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">handleError</span><span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> $log.error(<span class="">'Verfication error '</span>, err);</pre>

<pre class=""> $ionicPopup.alert({</pre>
<pre class=""> title: err.reason || <span class="">'Verfication failed'</span>,</pre>
<pre class=""> template: <span class="">'Please try again'</span>,</pre>
<pre class=""> okType: <span class="">'button-positive button-clear'</span></pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>We will use Accounts API again to verify the user and in case of successful authentication we will transition to the <code>profile</code>&#xA0;state, which we add in the next step.</p>
<p>This is the <code>profile</code>&#xA0;view, which provides the ability to enter the user&#x2019;s nickname and profile picture (which we will add in the next step).</p>
<div><strong>4.11</strong>&#xA0; Add the profile settings view <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/e9e44be8b70c8b0db48d1c554a0b8c2c07558cf9"> client/templates/profile.ng.html &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">"Profile"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"updateName()"</span> <span class="">ng-disabled</span>=<span class="">"!data.name || data.name.length === 0"</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span>&gt;</span>Done<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"profile"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">a</span> <span class="">class</span>=<span class="">"profile-picture positive"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"upload-placehoder"</span>&gt;</span></pre>
<pre class=""> Add photo</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">a</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"instructions"</span>&gt;</span></pre>
<pre class=""> Enter your name and add an optional profile picture</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"list profile-name"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">label</span> <span class="">class</span>=<span class="">"item item-input"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">input</span> <span class="">ng-model</span>=<span class="">"data.name"</span> <span class="">on-return</span>=<span class="">"updateName()"</span> <span class="">type</span>=<span class="">"text"</span> <span class="">placeholder</span>=<span class="">"Your name"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">label</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And the controller:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ProfileCtrl'</span>, ProfileCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ProfileCtrl</span> <span class="hljs-params">($scope, $state, $meteor, $ionicPopup, $log)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> user = Meteor.user();</pre>
<pre class=""> <span class="hljs-keyword">var</span> name = user &amp;&amp; user.profile ? user.profile.name : <span class="">''</span>;</pre>

<pre class=""> $scope.data = {</pre>
<pre class=""> name: name</pre>
<pre class=""> };</pre>

<pre class=""> $scope.updateName = updateName;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">updateName</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.name)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> $meteor.call(<span class="">'updateName'</span>, $scope.data.name)</pre>
<pre class=""> .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $state.go(<span class="">'tab.chats'</span>);</pre>
<pre class=""> })</pre>
<pre class=""> .catch(handleError);</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">handleError</span> <span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> $log.error(<span class="">'profile save error '</span>, err);</pre>

<pre class=""> $ionicPopup.alert({</pre>
<pre class=""> title: err.reason || <span class="">'Save failed'</span>,</pre>
<pre class=""> template: <span class="">'Please try again'</span>,</pre>
<pre class=""> okType: <span class="">'button-positive button-clear'</span></pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And some CSS:</p>
<div><strong>4.13</strong>&#xA0; Add CSS for the profile settings view <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/114ae6750d4943cc8416e57df3e0476a5b795f41"> client/styles/profile.scss &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
</div>
<div>
<pre class="">.profile {</pre>
<pre class=""> padding-top: 20px;</pre>

<pre class=""> .profile-picture {</pre>
<pre class=""> position: absolute;</pre>
<pre class=""> top: 0;</pre>
<pre class=""> left: 20px;</pre>
<pre class=""> text-align: center;</pre>

<pre class=""> img {</pre>
<pre class=""> display: block;</pre>
<pre class=""> max-width: 50px;</pre>
<pre class=""> max-height: 50px;</pre>
<pre class=""> width: 100%;</pre>
<pre class=""> height: 100%;</pre>
<pre class=""> border-radius: 50%;</pre>
<pre class=""> }</pre>

<pre class=""> .upload-placehoder {</pre>
<pre class=""> width: 50px;</pre>
<pre class=""> height: 50px;</pre>
<pre class=""> padding: 5px;</pre>
<pre class=""> border: 1px solid #808080;</pre>
<pre class=""> border-radius: 50%;</pre>
<pre class=""> line-height: 18px;</pre>
<pre class=""> font-size: 12px;</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>

<pre class=""> .instructions {</pre>
<pre class=""> min-height: 60px;</pre>
<pre class=""> padding: 10px 20px 20px 90px;</pre>
<pre class=""> font-size: 14px;</pre>
<pre class=""> color: gray;</pre>
<pre class=""> }</pre>

<pre class=""> .profile-name {</pre>
<pre class=""> margin-top: 20px;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>As you can see, the controller uses a server method - <code>updateName</code>&#xA0;which we need to implement in the `lib/methods.js`:</p>
<div><strong>4.14</strong>&#xA0; Add updateName method to the server <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/267bb76c7e73a8b95d6725b104ea14facc7bb689"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
</div>
<div>
<pre class=""> Chats.update(message.chatId, { $set: { lastMessage: message } });</pre>

<pre class=""> <span class="hljs-keyword">return</span> messageId;</pre>
<pre class=""> },</pre>
<pre class=""> updateName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'not-logged-in'</span>,</pre>
<pre class=""> <span class="">'Must be logged in to update his name.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(name, <span class="hljs-built_in">String</span>);</pre>
<pre class=""> <span class="hljs-keyword">if</span> (name.length === <span class="hljs-number">0</span>) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> Meteor.Error(<span class="">'name-required'</span>, <span class="">'Must proive user name'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.update(<span class="hljs-keyword">this</span>.userId, { $set: { <span class="">'profile.name'</span>: name } });</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>Meteor sets the user identity in case of a logged in user into the <code>this.userId</code>&#xA0;variable, so we can check if this variable exists in order to verify that the user is logged in.</p>
<p>Now let&#x2019;s add this validation to the <code>newMessage</code>&#xA0;we created earlier, and also add the identity of the user to each message he sends.</p>
<div><strong>4.15</strong>&#xA0; Verify and add userId for each message that sent <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/5476c7080840a0325566fa029c3f26d8459d1e38"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
</div>
<div>
<pre class="">Meteor.methods({</pre>
<pre class=""> newMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'not-logged-in'</span>,</pre>
<pre class=""> <span class="">'Must be logged in to send message.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(message, {</pre>
<pre class=""> text: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> chatId: <span class="hljs-built_in">String</span></pre>
<pre class=""> });</pre>

<pre class=""> message.timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</pre>
<pre class=""> message.userId = <span class="hljs-keyword">this</span>.userId;</pre>

<pre class=""> <span class="hljs-keyword">var</span> messageId = Messages.insert(message);</pre>
<pre class=""> Chats.update(message.chatId, { $set: { lastMessage: message } });</pre>
</div>
</div>
</div>
<p><br>Great, now the last missing feature is logout - let&#x2019;s add a state for the settings view:</p>
<div><strong>4.16</strong>&#xA0; Add settings route definition <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/4ce70e86e79049761c806e0bdce1c5aa9132f24b"> client/scripts/routes.ng.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
<pre>58</pre>
<pre>59</pre>
<pre>60</pre>
<pre>61</pre>
<pre>62</pre>
<pre>63</pre>
<pre>64</pre>
<pre>65</pre>
</div>
<div>
<pre class=""> <span class="hljs-keyword">return</span> $meteor.requireUser();</pre>
<pre class=""> }]</pre>
<pre class=""> }</pre>
<pre class=""> })</pre>
<pre class=""> .state(<span class="">'tab.settings'</span>, {</pre>
<pre class=""> url: <span class="">'/settings'</span>,</pre>
<pre class=""> views: {</pre>
<pre class=""> <span class="">'tab-settings'</span>: {</pre>
<pre class=""> templateUrl: <span class="">'client/templates/settings.ng.html'</span>,</pre>
<pre class=""> controller: <span class="">'SettingsCtrl'</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> });</pre>

<pre class=""> $urlRouterProvider.otherwise(<span class="">'tab/chats'</span>);</pre>
</div>
</div>
</div>
<p><br>And create the view - it only contains the logout button which calls a $scope method:</p>

<div>
<div>

<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">view-title</span>=<span class="">"Settings"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"padding text-center"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"logout()"</span> <span class="">class</span>=<span class="">"button button-clear button-assertive"</span>&gt;</span>Logout<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And let&#x2019;s implement this method inside the `SettingsCtrl`:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'SettingsCtrl'</span>, SettingsCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">SettingsCtrl</span><span class="hljs-params">($scope, $meteor, $state)</span> </span>{</pre>
<pre class=""> $scope.logout = logout;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">logout</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $meteor.logout().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $state.go(<span class="">'login'</span>);</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And this is our settings view:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/14_-_Logout_screen.png?t=1445014944449" title=""><br> </p><p>We also need to modify the way we identify our users inside the messages list, so let&#x2019;s do it:</p>

<div>
<div>

<div>
<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"chat"</span> <span class="">delegate-handle</span>=<span class="">"chatScroll"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-list"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-repeat</span>=<span class="">"message in messages"</span> <span class="">class</span>=<span class="">"message-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message"</span> <span class="">ng-class-even</span>=<span class="">"'message-mine'"</span> <span class="">ng-class-odd</span>=<span class="">"'message-other'"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message"</span> <span class="">ng-class</span>=<span class="">"message.userId === $root.currentUser._id ? 'message-mine' : 'message-other'"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And the last missing feature is about adding auto-scroll to the messages list in order to keep the view scrolled down when new message arrives!</p>

<div>
<div>
<div>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
</div>
<div>
<pre class=""> <span class="hljs-keyword">return</span> Messages.find({ chatId: chatId });</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $scope.$watchCollection(<span class="">'messages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oldVal, newVal)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> animate = oldVal.length !== newVal.length;</pre>
<pre class=""> $ionicScrollDelegate.$getByHandle(<span class="">'chatScroll'</span>).scrollBottom(animate);</pre>
<pre class=""> });</pre>

<pre class=""> $scope.data = {};</pre>
<pre class=""> $scope.sendMessage = sendMessage;</pre>
<pre class=""> $scope.inputUp = inputUp;</pre>
</div>
</div>
</div>
<p><br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/978d20a9823aa412b0f08299d59dd7a84d7dca17.zip"><span>here</span></a>.<br> <br> <br><strong><span>Step 6 - Create and remove chats</span></strong></p>
<p>Our next step is about adding the ability to create new chats - so far we have the chats list and the users feature - we just need to connect them.</p>
<p>We will open the new chat view using Ionic&#x2019;s modal dialog, so first let&#x2019;s add a button that opens this dialog to the chats list:</p>

<div>
<div>

<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">view-title</span>=<span class="">"Chats"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"openNewChatModal()"</span> <span class="">class</span>=<span class="">"button button-clear button-positive button-icon ion-ios-compose-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-item</span></span></pre>
</div>
</div>
</div>
<p><br>This button calls a $scope function, which we will implement now in the controller:</p>

<div>
<div>
<div>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
</div>
<div>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatsCtrl'</span>, ChatsCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatsCtrl</span> <span class="hljs-params">($scope)</span> </span>{</pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatsCtrl</span> <span class="hljs-params">($scope, $ionicModal)</span> </span>{</pre>
<pre class=""> $scope.chats = $scope.$meteorCollection(Chats, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $ionicModal.fromTemplateUrl(<span class="">'client/templates/new-chat.ng.html'</span>, {</pre>
<pre class=""> scope: $scope</pre>
<pre class=""> }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(modal)</span> </span>{</pre>
<pre class=""> $scope.modal = modal;</pre>
<pre class=""> });</pre>

<pre class=""> $scope.$on(<span class="">'$destroy'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $scope.modal.remove();</pre>
<pre class=""> });</pre>

<pre class=""> $scope.openNewChatModal = openNewChatModal;</pre>
<pre class=""> $scope.remove = remove;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">openNewChatModal</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $scope.modal.show();</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">remove</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> $scope.chats.remove(chat);</pre>
<pre class=""> }</pre>
</div>
</div>
</div>
<p><br>Note that we first create the modal dialog with a template, and then later we open it in the button function.<br>Now let&#x2019;s add the view of this modal dialog, which is just a list of users:</p>
<div><strong>5.3</strong>&#xA0; Add the view of the new chat modal <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/232e1715b1a07ae6b9fa9e1b9414c79f2c40d28f"> client/templates/new-chat.ng.html &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
</div>
<div>
<pre class=""><span class="">&lt;<span class="">ion-modal-view</span> <span class="">ng-controller</span>=<span class="">"NewChatCtrl"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-header-bar</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h1</span> <span class="">class</span>=<span class="">"title"</span>&gt;</span>New Chat<span class="">&lt;/<span class="">h1</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"buttons"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span> <span class="">ng-click</span>=<span class="">"hideModal()"</span>&gt;</span>Cancel<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-header-bar</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-content</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"list"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">a</span> <span class="">ng-repeat</span>=<span class="">"user in users"</span> <span class="">ng-click</span>=<span class="">"newChat(user._id)"</span> <span class="">class</span>=<span class="">"item"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span></pre>
<pre class=""> Hey there! I am using meteor-Whatsapp with meteor.</pre>
<pre class=""> <span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">a</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-modal-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And now we will add the controller of this view:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'NewChatCtrl'</span>, NewChatCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">NewChatCtrl</span><span class="hljs-params">($scope, $state, $meteor)</span> </span>{</pre>
<pre class=""> $scope.users = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find({_id: {$ne: Meteor.userId()}});</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>

<pre class=""> $scope.hideModal = hideModal;</pre>
<pre class=""> $scope.newChat = newChat;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">hideModal</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $scope.modal.hide();</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">newChat</span><span class="hljs-params">(userId)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chat = Chats.findOne({type: <span class="">'chat'</span>, userIds: {$all: [Meteor.userId(), userId]}});</pre>
<pre class=""> <span class="hljs-keyword">if</span> (chat) {</pre>
<pre class=""> <span class="hljs-keyword">return</span> goToChat(chat._id);</pre>
<pre class=""> }</pre>

<pre class=""> $meteor.call(<span class="">'newChat'</span>, userId).then(goToChat);</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">goToChat</span><span class="hljs-params">(chatId)</span> </span>{</pre>
<pre class=""> hideModal();</pre>
<pre class=""> <span class="hljs-keyword">return</span> $state.go(<span class="">'tab.chat-detail'</span>, {chatId: chatId});</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>It includes the Users collection and a function for creating a new chat - this function is not yet implemented in the server, so let&#x2019;s create it in the server:</p>
<div><strong>5.5</strong>&#xA0; Add server side logic for creating new chat <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/99088da6f15f6e127277e07a5270299b41a14b38"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
</div>
<div>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.update(<span class="hljs-keyword">this</span>.userId, { $set: { <span class="">'profile.name'</span>: name } });</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> newChat: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(otherId)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'not-logged-in'</span>,</pre>
<pre class=""> <span class="">'Must be logged to create a chat.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(otherId, <span class="hljs-built_in">String</span>);</pre>

<pre class=""> <span class="hljs-keyword">var</span> otherUser = Meteor.users.findOne(otherId);</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! otherUser) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'user-not-exists'</span>,</pre>
<pre class=""> <span class="">'Chat\'s user not exists'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">var</span> chat = {</pre>
<pre class=""> userIds: [<span class="hljs-keyword">this</span>.userId, otherId],</pre>
<pre class=""> createdAt: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()</pre>
<pre class=""> };</pre>

<pre class=""> <span class="hljs-keyword">var</span> chatId = Chats.insert(chat);</pre>

<pre class=""> <span class="hljs-keyword">return</span> chatId;</pre>
<pre class=""> },</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>We will also change the logic of <code>removeChat</code>&#xA0;function in the <code>ChatsCtrl</code>&#xA0;- we also call a server method (I will explain the reason for this change soon):</p>

<div>
<div>

<div>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">remove</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> $scope.chats.remove(chat);</pre>
<pre class=""> $meteor.call(<span class="">'removeChat'</span>, chat._id);</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And we will implement the method on the server:</p>
<div><strong>5.7</strong>&#xA0; Add server side logic for removing chats <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/c9c3a132c43c1ce6372b5a231c0c8fc4ad752b0e"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
<pre>58</pre>
<pre>59</pre>
<pre>60</pre>
<pre>61</pre>
<pre>62</pre>
<pre>63</pre>
<pre>64</pre>
<pre>65</pre>
<pre>66</pre>
<pre>67</pre>
<pre>68</pre>
<pre>69</pre>
<pre>70</pre>
<pre>71</pre>
<pre>72</pre>
<pre>73</pre>
<pre>74</pre>
<pre>75</pre>
</div>
<div>

<pre class=""> <span class="hljs-keyword">return</span> chatId;</pre>
<pre class=""> },</pre>
<pre class=""> removeChat: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chatId)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'not-logged-in'</span>,</pre>
<pre class=""> <span class="">'Must be logged to create a chat.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(chatId, <span class="hljs-built_in">String</span>);</pre>

<pre class=""> <span class="hljs-keyword">var</span> chat = Chats.findOne(chatId);</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! chat || ! _.include(chat.userIds, <span class="hljs-keyword">this</span>.userId)) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'chat-not-exists'</span>,</pre>
<pre class=""> <span class="">'Chat not exists'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> Messages.remove({ chatId: chatId });</pre>

<pre class=""> <span class="hljs-keyword">return</span> Chats.remove({ _id: chatId });</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>The next messages won&#x2019;t include the username, only the user id, so we need to change the logic of username display - we will add a filter that fetches the user object from the Users collection according to the <code>userId</code>&#xA0;property of the chat object:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .filter(<span class="">'chatName'</span>, chatName);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">chatName</span><span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (!chat) <span class="hljs-keyword">return</span>;</pre>

<pre class=""> <span class="hljs-keyword">var</span> otherId = _.without(chat.userIds, Meteor.userId())[<span class="hljs-number">0</span>];</pre>
<pre class=""> <span class="hljs-keyword">var</span> otherUser = Meteor.users.findOne(otherId);</pre>
<pre class=""> <span class="hljs-keyword">var</span> hasName = otherUser &amp;&amp; otherUser.profile &amp;&amp; otherUser.profile.name;</pre>

<pre class=""> <span class="hljs-keyword">return</span> hasName ? otherUser.profile.name : chat.name || <span class="">'NO NAME'</span>;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And we will also create the same logic for fetching the user&#x2019;s image:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class="">angular</pre>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .filter(<span class="">'chatPicture'</span>, chatPicture);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">chatPicture</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! chat) <span class="hljs-keyword">return</span>;</pre>

<pre class=""> <span class="hljs-keyword">var</span> otherId = _.without(chat.userIds, Meteor.userId())[<span class="hljs-number">0</span>];</pre>
<pre class=""> <span class="hljs-keyword">var</span> otherUser = Meteor.users.findOne(otherId);</pre>
<pre class=""> <span class="hljs-keyword">var</span> hasPicture = otherUser &amp;&amp; otherUser.profile &amp;&amp; otherUser.profile.picture;</pre>

<pre class=""> <span class="hljs-keyword">return</span> hasPicture ? otherUser.profile.picture : chat.picture || <span class="">'/user-default.svg'</span>;</pre>
<pre class=""> }</pre>
<pre class="">}</pre>
</div>
</div>
</div>
<p><br>And we will add the usage of this filter in the chats list:</p>
<div><strong>5.10</strong>&#xA0; Add filters usage in the chats list <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/f459fde81a91cefd867cab18243ef68b1fc0fc14"> client/templates/chats.ng.html &#xBB; </a></div>
<div>
<div>

<div>
<pre class=""> class="item-chat item-remove-animate item-avatar item-icon-right"</pre>
<pre class=""> type="item-text-wrap"</pre>
<pre class=""> href="#/tab/chats/"&gt;</pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And in the chat detail view:</p>

<div>
<div>

<div>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""><span class="">&lt;<span class="">ion-view</span> <span class="">title</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-nav-buttons</span> <span class="">side</span>=<span class="">"right"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear"</span>&gt;</span><span class="">&lt;<span class="">img</span> <span class="">class</span>=<span class="">"header-picture"</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear"</span>&gt;</span><span class="">&lt;<span class="">img</span> <span class="">class</span>=<span class="">"header-picture"</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"chat"</span> <span class="">delegate-handle</span>=<span class="">"chatScroll"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-list"</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>Now we want to get rid of the current data we have - which is just a static data.</p>
<p>So let&#x2019;s stop our Meteor&#x2019;s server and reset the whole app by running:</p>
<p><code>$ meteor reset</code></p>
<p><br>Let&#x2019;s add some users to the server instead of the old static data:</p>

<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
</div>
<div>
<pre class="">Meteor.startup(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (Chats.find().count() === <span class="hljs-number">0</span>) {</pre>
<pre class=""> Messages.remove({});</pre>

<pre class=""> <span class="hljs-keyword">var</span> messages = [</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'You on your way?'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'Hey, it\'s me'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'hours'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'I should buy a boat'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">1</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'Look at my mukluks!'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">4</span>, <span class="">'days'</span>).toDate()</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="">'This is wicked good ice cream.'</span>,</pre>
<pre class=""> timestamp: moment().subtract(<span class="hljs-number">2</span>, <span class="">'weeks'</span>).toDate()</pre>
<pre class=""> <span class="hljs-keyword">if</span> (Accounts.users.find().count() === <span class="hljs-number">0</span>) {</pre>
<pre class=""> Accounts.createUserWithPhone({</pre>
<pre class=""> phone: <span class="">'+972501234567'</span>,</pre>
<pre class=""> profile: {</pre>
<pre class=""> name: <span class="">'My friend 1'</span></pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>

<pre class=""> messages.forEach(m =&gt; {</pre>
<pre class=""> Messages.insert(m);</pre>
<pre class=""> });</pre>

<pre class=""> <span class="hljs-keyword">var</span> chats = [</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Ethan Gonzalez'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Bryan Wallace'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/lego/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Avery Stewart'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/1.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Katie Peterson'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/women/2.jpg'</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> name: <span class="">'Ray Edwards'</span>,</pre>
<pre class=""> picture: <span class="">'https://randomuser.me/api/portraits/thumb/men/2.jpg'</span></pre>
<pre class=""> Accounts.createUserWithPhone({</pre>
<pre class=""> phone: <span class="">'+972501234568'</span>,</pre>
<pre class=""> profile: {</pre>
<pre class=""> name: <span class="">'My friend 2'</span></pre>
<pre class=""> }</pre>
<pre class=""> ];</pre>
<pre class=""> });</pre>

<pre class=""> chats.forEach(chat =&gt; {</pre>
<pre class=""> <span class="hljs-keyword">let</span> message = Messages.findOne({chatId: {$exists: <span class="hljs-literal">false</span>}});</pre>
<pre class=""> chat.lastMessage = message;</pre>
<pre class=""> <span class="hljs-keyword">let</span> chatId = Chats.insert(chat);</pre>
<pre class=""> Messages.update(message._id, {$set: {chatId: chatId}})</pre>
<pre class=""> Accounts.createUserWithPhone({</pre>
<pre class=""> phone: <span class="">'+972501234569'</span>,</pre>
<pre class=""> profile: {</pre>
<pre class=""> name: <span class="">'My friend 3'</span></pre>
<pre class=""> }</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>Run it again, this is the result of the new Modal we created:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/15_-_New_chat_screen.png?t=1445014944449" title=""></p><p>Cool ! and now clicking a user will open a chat with that user!<br>Our last part of this step is to remove Meteor&#x2019;s package named <code>insecure</code>.</p>
<p>This package provides the ability to run `remove` method from the client side in our collection - this is behavior we do not want to use because removing data and creating data should be done in the server side and only after certain validations - and this is the reason for implementing the `removeChat` method in the server.</p>
<p>Meteor includes this package only for prototyping purpose the it should be removed when our app is ready!</p>
<p>So removing this package is only running this command:</p>
<p><code>$ meteor remove insecure</code></p>
<p><br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/59f69393dca4b25e11cefdaaca7dd6e652c62923.zip"><span>here</span></a>.<br> <br><strong><span>Step 7 - Privacy and Publish/Subscribe</span></strong></p>
<p>Right now all the chats are published to all the clients. that not very private - let&#x2019;s fix that.</p>
<p>First thing we need to do to stop all the automatic publication of information is to remove the <code>autopublish</code>&#xA0;package from the Meteor server. in the Meteor command line:</p>
<p><code>$ meteor remove autopublish</code></p>
<p><br>We will add now the <a href="https://atmospherejs.com/reywood/publish-composite" target="_blank">publish-composite</a>&#xA0;package, which we will use later.</p>
<p><code>$ meteor add reywood:publish-composite</code></p>
<p><br>Now we need to explicitly define our publications - let&#x2019;s start with sending the Users information.</p>
<p>Create a file named `publications.js` under the `server` folder and define the query we want to send to our clients inside:</p>
<div><strong>6.3</strong>&#xA0; Add publication to the users <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/32d753750e12e2660bbf8908d756eecbe86f0a5d"> server/publications.js &#xBB; </a></div>
<div>
<div>

<div>
<pre class="">Meteor.publish(<span class="">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find({}, { fields: { profile: <span class="hljs-number">1</span> } });</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>And of course we need to modify some of the client side code, we need to make sure that the client side subscribed to the Users data, so let&#x2019;s add in the new chat page controller, because this view needs the users&#x2019; data:</p>

<div>
<div>
<div>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
</div>
<div>
<pre class=""> .controller(<span class="">'NewChatCtrl'</span>, NewChatCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">NewChatCtrl</span><span class="hljs-params">($scope, $state, $meteor)</span> </span>{</pre>
<pre class=""> $scope.users = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find({_id: {$ne: Meteor.userId()}});</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>
<pre class=""> $scope.$meteorSubscribe(<span class="">'users'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $scope.users = $scope.$meteorCollection(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find({ _id: { $ne: Meteor.userId() } });</pre>
<pre class=""> }, <span class="hljs-literal">false</span>);</pre>
<pre class=""> });</pre>

<pre class=""> $scope.hideModal = hideModal;</pre>
<pre class=""> $scope.newChat = newChat;</pre>
</div>
</div>
</div>
<p><br>Now let&#x2019;s do a more complex publication, let&#x2019;s send each client only the Chats and Messages he is a part of:<br><code>Meteor.publish('chats', function () {</code></p>
<p><code>&#xA0; if (! this.userId) {</code></p>
<p><code>&#xA0; &#xA0; return;</code></p>

<p><code>&#xA0; return Chats.find({ userIds: this.userId });</code></p>
<p><code>});</code></p>
<p><br>and now, let&#x2019;s add the Messages from the those chats into the publication.</p>
<p>To do that, we need to do a joined collections publication.</p>
<p>To do it more easily, let&#x2019;s use the <a href="https://atmospherejs.com/reywood/publish-composite" target="_blank">reywood:publish-composite</a>&#xA0;package we added previously.</p>
<p>And now let&#x2019;s change the publication to add the Messages and the Users that are related to the Chats the users in participating in:</p>
<div><strong>6.5</strong>&#xA0; Add publication to chats and messages data <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/f1225326e5a6df3f75baeb2de4fbb2e334b2cf9b"> server/publications.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>1</pre>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
</div>
<div>
<pre class="">Meteor.publish(<span class="">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find({}, { fields: { profile: <span class="hljs-number">1</span> } });</pre>
<pre class="">});</pre>

<pre class="">Meteor.publishComposite(<span class="">'chats'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">return</span> {</pre>
<pre class=""> find: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Chats.find({ userIds: <span class="hljs-keyword">this</span>.userId });</pre>
<pre class=""> },</pre>
<pre class=""> children: [</pre>
<pre class=""> {</pre>
<pre class=""> find: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> Messages.find({ chatId: chat._id });</pre>
<pre class=""> }</pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> find: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chat)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> query = { _id: { $<span class="hljs-keyword">in</span>: chat.userIds } };</pre>
<pre class=""> <span class="hljs-keyword">var</span> options = { fields: { profile: <span class="hljs-number">1</span> } };</pre>

<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.find(query, options);</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>
<pre class=""> ]</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>And we will add the subscription to the <code>chats</code>&#xA0;data in the client side:</p>

<div>
<div>
<div>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
</div>
<div>
<pre class=""> resolve: {</pre>
<pre class=""> user: [<span class="">'$meteor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($meteor)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> $meteor.requireUser();</pre>
<pre class=""> }],</pre>
<pre class=""> chats: [<span class="">'$meteor'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($meteor)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">return</span> $meteor.subscribe(<span class="">'chats'</span>);</pre>
<pre class=""> }]</pre>
<pre class=""> }</pre>
<pre class=""> })</pre>
</div>
</div>
</div>
<p><br>Notice that the <code><a href="http://angular-meteor.com/api/subscribe"><span>$meteorSubscribe</span></a></code>&#xA0;function resolve a promise when the data arrives so you know when you can use it.</p>
<p><br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/91b36046acce0f4fdc11a3f39cbe5ad79bfab4f7.zip"><span>here</span></a>.<br> <br><strong><span>Step 8 - User profile picture</span></strong></p>
<p>So now we will add an ability to add a user profile image - using the device&#x2019;s camera (mobile phone or laptop camera).</p>
<p>The first part is to add the Meteor package that provide us this ability:</p>
<p><code>$ meteor add okland:camera-ui</code></p>
<p><br>We will add now a server method for updating the user&#x2019;s profile image, which is just like updating any other string field of the user&#x2019;s profile:</p>
<div><strong>7.2</strong>&#xA0; Add updatePicture method to the server <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/1fed673bffba9f6b5fa03490fe6b667aa8d13563"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>71</pre>
<pre>72</pre>
<pre>73</pre>
<pre>74</pre>
<pre>75</pre>
<pre>76</pre>
<pre>77</pre>
<pre>78</pre>
<pre>79</pre>
<pre>80</pre>
<pre>81</pre>
<pre>82</pre>
<pre>83</pre>
<pre>84</pre>
<pre>85</pre>
</div>
<div>
<pre class=""> Messages.remove({ chatId: chatId });</pre>

<pre class=""> <span class="hljs-keyword">return</span> Chats.remove({ _id: chatId });</pre>
<pre class=""> },</pre>
<pre class=""> updatePicture: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">this</span>.userId) {</pre>
<pre class=""> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="">'not-logged-in'</span>,</pre>
<pre class=""> <span class="">'Must be logged in to update his picture.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(data, <span class="hljs-built_in">String</span>);</pre>

<pre class=""> <span class="hljs-keyword">return</span> Meteor.users.update(<span class="hljs-keyword">this</span>.userId, { $set: { <span class="">'profile.picture'</span>: data } });</pre>
<pre class=""> }</pre>
<pre class="">});</pre>
</div>
</div>
</div>
<p><br>The next step is to add the button for adding/editing the user&#x2019;s profile image, we will add it in the <code>profile</code>&#xA0;state, so update the view first:</p>

<div>
<div>
<div>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
</div>
<div>
<pre class=""> <span class="">&lt;/<span class="">ion-nav-buttons</span>&gt;</span></pre>

<pre class=""> <span class="">&lt;<span class="">ion-content</span> <span class="">class</span>=<span class="">"profile"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">a</span> <span class="">class</span>=<span class="">"profile-picture positive"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"upload-placehoder"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">a</span> <span class="">class</span>=<span class="">"profile-picture positive"</span> <span class="">ng-click</span>=<span class="">"updatePicture()"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-if</span>=<span class="">"currentUser.profile.picture"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span> <span class="">alt</span>=<span class="">"profile picture"</span>&gt;</span></pre>
<pre class=""> edit</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-if</span>=<span class="">"!currentUser.profile.picture"</span> <span class="">class</span>=<span class="">"upload-placehoder"</span>&gt;</span></pre>
<pre class=""> Add photo</pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">a</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And now we will implement the controller methods, which users Camera-UI API for getting the image from the device, and then we will use that image and run the server method for updating the image:</p>

<div>
<div>
<div>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>

<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
</div>
<div>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ProfileCtrl'</span>, ProfileCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ProfileCtrl</span> <span class="hljs-params">($scope, $state, $meteor, $ionicPopup, $log)</span> </span>{</pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ProfileCtrl</span> <span class="hljs-params">($scope, $state, $meteor, $ionicPopup, $log, $ionicLoading)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> user = Meteor.user();</pre>
<pre class=""> <span class="hljs-keyword">var</span> name = user &amp;&amp; user.profile ? user.profile.name : <span class="">''</span>;</pre>

<pre class=""><span class="">...some lines skipped...</span></pre>
<pre class=""> };</pre>

<pre class=""> $scope.updateName = updateName;</pre>
<pre class=""> $scope.updatePicture = updatePicture;</pre>

<pre class=""> <span class="">////////////</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">updatePicture</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> MeteorCameraUI.getPicture({ width: <span class="hljs-number">60</span>, height: <span class="hljs-number">60</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (err &amp;&amp; err.error == <span class="">'cancel'</span>) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">if</span> (err) {</pre>
<pre class=""> <span class="hljs-keyword">return</span> handleError(err);</pre>
<pre class=""> }</pre>

<pre class=""> $ionicLoading.show({</pre>
<pre class=""> template: <span class="">'Updating picture...'</span></pre>
<pre class=""> });</pre>

<pre class=""> $meteor.call(<span class="">'updatePicture'</span>, data)</pre>
<pre class=""> .finally(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> $ionicLoading.hide();</pre>
<pre class=""> })</pre>
<pre class=""> .catch(handleError);</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">updateName</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.name)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
</div>
</div>
</div>
<p><br>We will add now some CSS for better layout of the profile page:</p>
<div><strong>7.5</strong>&#xA0; Add some CSS style to the profile page <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/ea1a45fbbb24823442799959a09c7a3272b60f49"> client/styles/profile.scss &#xBB; </a></div>
<div>
<div>

<div>
<pre class=""> display: block;</pre>
<pre class=""> max-width: 50px;</pre>
<pre class=""> max-height: 50px;</pre>
<pre class=""> min-width: 50px;</pre>
<pre class=""> min-height: 50px;</pre>
<pre class=""> width: 100%;</pre>
<pre class=""> height: 100%;</pre>
<pre class=""> border-radius: 50%;</pre>
</div>
</div>
</div>
<p><br>And this is an example for taking an image from the browser:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/16-_Take_photo_screen.png?t=1445014944449" title=""></p><p>Now to ease the access to the profile page, we will add a link in the Settings view:</p>

<div>
<div>
<div>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
</div>
<div>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"padding text-center"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"logout()"</span> <span class="">class</span>=<span class="">"button button-clear button-assertive"</span>&gt;</span>Logout<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-item</span> <span class="">href</span>=<span class="">"#/profile"</span> <span class="">class</span>=<span class="">"item-icon-right"</span>&gt;</span></pre>
<pre class=""> Profile</pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-item</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-list</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ion-content</span>&gt;</span></pre>
<pre class=""><span class="">&lt;/<span class="">ion-view</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/2c97fa41b5c2f106099f9ec988a0d4129c3a4fd7.zip"><span>here</span></a>.<br> <br><strong><span>Step 9 - Send image messages</span></strong><br> <br>Our last step is adding ability to send image message in the chat. We will use the same package from the previous step!</p>
<p>So we will use the same logic of taking the picture in the controller, and call the same <code>newMessage</code>&#xA0;server method:</p>

<div>
<div>
<div>
<pre>2</pre>
<pre>3</pre>
<pre>4</pre>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>

<pre>21</pre>
<pre>22</pre>
<pre>23</pre>
<pre>24</pre>
<pre>25</pre>
<pre>26</pre>
<pre>27</pre>
<pre>28</pre>
<pre>29</pre>
<pre>30</pre>
<pre>31</pre>
<pre>32</pre>
<pre>33</pre>
<pre>34</pre>
<pre>35</pre>
<pre>36</pre>
<pre>37</pre>
<pre>38</pre>
<pre>39</pre>
<pre>40</pre>
<pre>41</pre>
<pre>42</pre>
<pre>43</pre>
<pre>44</pre>
<pre>45</pre>
<pre>46</pre>
<pre>47</pre>
<pre>48</pre>
<pre>49</pre>
<pre>50</pre>
<pre>51</pre>
<pre>52</pre>
<pre>53</pre>
<pre>54</pre>
<pre>55</pre>
<pre>56</pre>
<pre>57</pre>
</div>
<div>
<pre class=""> .module(<span class="">'Whatsapp'</span>)</pre>
<pre class=""> .controller(<span class="">'ChatDetailCtrl'</span>, ChatDetailCtrl);</pre>

<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams, $ionicScrollDelegate, $timeout, $meteor)</span> </span>{</pre>
<pre class=""><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">ChatDetailCtrl</span> <span class="hljs-params">($scope, $stateParams, $ionicScrollDelegate, $timeout, $meteor, $ionicPopup, $log)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">var</span> chatId = $stateParams.chatId;</pre>
<pre class=""> <span class="hljs-keyword">var</span> isIOS = ionic.Platform.isWebView() &amp;&amp; ionic.Platform.isIOS();</pre>
<pre class=""> $scope.chat = $scope.$meteorObject(Chats, chatId, <span class="hljs-literal">false</span>);</pre>
<pre class=""><span class="">...some lines skipped...</span></pre>
<pre class=""> $scope.inputUp = inputUp;</pre>
<pre class=""> $scope.inputDown = inputDown;</pre>
<pre class=""> $scope.closeKeyboard = closeKeyboard;</pre>
<pre class=""> $scope.sendPicture = sendPicture;</pre>

<pre class=""> <span class="">///</span></pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">sendPicture</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> MeteorCameraUI.getPicture({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (err &amp;&amp; err.error == <span class="">'cancel'</span>) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-keyword">if</span> (err) {</pre>
<pre class=""> <span class="hljs-keyword">return</span> handleError(err);</pre>
<pre class=""> }</pre>

<pre class=""> $meteor.call(<span class="">'newMessage'</span>, {</pre>
<pre class=""> picture: data,</pre>
<pre class=""> type: <span class="">'picture'</span>,</pre>
<pre class=""> chatId: chatId</pre>
<pre class=""> });</pre>
<pre class=""> });</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">handleError</span> <span class="hljs-params">(err)</span> </span>{</pre>
<pre class=""> $log.error(<span class="">'profile save error '</span>, err);</pre>
<pre class=""> $ionicPopup.alert({</pre>
<pre class=""> title: err.reason || <span class="">'Save failed'</span>,</pre>
<pre class=""> template: <span class="">'Please try again'</span>,</pre>
<pre class=""> okType: <span class="">'button-positive button-clear'</span></pre>
<pre class=""> });</pre>
<pre class=""> }</pre>

<pre class=""> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="">sendMessage</span> <span class="hljs-params">()</span> </span>{</pre>
<pre class=""> <span class="hljs-keyword">if</span> (_.isEmpty($scope.data.message)) {</pre>
<pre class=""> <span class="hljs-keyword">return</span>;</pre>
</div>
</div>
</div>
<p><br>And now we need to add the <code>ng-click</code>&#xA0;to the image button on the view:</p>

<div>
<div>

<div>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"sendMessage()"</span> <span class="">class</span>=<span class="">"button button-clear button-positive"</span>&gt;</span>Send<span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">ng-if</span>=<span class="">"!data.message || data.message.length === 0"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-camera-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">ng-click</span>=<span class="">"sendPicture()"</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-camera-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"buttons-seperator icon ion-android-more-vertical"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">button</span> <span class="">class</span>=<span class="">"button button-clear button-icon button-positive icon ion-ios-mic-outline"</span>&gt;</span><span class="">&lt;/<span class="">button</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">span</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>In the server, we need to add support for sending image messages - it&#x2019;s just another validation scheme for the <code>newMessage</code>&#xA0;method:</p>
<div><strong>8.3</strong>&#xA0; Add validation for image messages in the sendMessage method <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/commit/6f275f7b91da109bd2718e83acbfa1c4a6b48afe"> lib/methods.js &#xBB; </a></div>
<div>
<div>
<div>
<pre>5</pre>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
<pre>22</pre>
</div>
<div>
<pre class=""> <span class="">'Must be logged in to send message.'</span>);</pre>
<pre class=""> }</pre>

<pre class=""> check(message, {</pre>
<pre class=""> text: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> chatId: <span class="hljs-built_in">String</span></pre>
<pre class=""> });</pre>
<pre class=""> check(message, Match.OneOf(</pre>
<pre class=""> {</pre>
<pre class=""> text: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> type: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> chatId: <span class="hljs-built_in">String</span></pre>
<pre class=""> },</pre>
<pre class=""> {</pre>
<pre class=""> picture: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> type: <span class="hljs-built_in">String</span>,</pre>
<pre class=""> chatId: <span class="hljs-built_in">String</span></pre>
<pre class=""> }</pre>
<pre class=""> ));</pre>

<pre class=""> message.timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</pre>
<pre class=""> message.userId = <span class="hljs-keyword">this</span>.userId;</pre>
</div>
</div>
</div>
<p><br>Our next step is to add the view of the image messages in the chat detail view:</p>

<div>
<div>
<div>
<pre>6</pre>
<pre>7</pre>
<pre>8</pre>
<pre>9</pre>
<pre>10</pre>
<pre>11</pre>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
</div>
<div>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-list"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-repeat</span>=<span class="">"message in messages"</span> <span class="">class</span>=<span class="">"message-wrapper"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message"</span> <span class="">ng-class</span>=<span class="">"message.userId === $root.currentUser._id ? 'message-mine' : 'message-other'"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">class</span>=<span class="">"message-text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ng-switch</span> <span class="">on</span>=<span class="">"message.type"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-switch-when</span>=<span class="">"text"</span> <span class="">class</span>=<span class="">"text"</span>&gt;</span><span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">div</span> <span class="">ng-switch-when</span>=<span class="">"picture"</span> <span class="">class</span>=<span class="">"picture"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ng-switch</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">div</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And some CSS to limit the images size:</p>

<div>
<div>
<div>
<pre>66</pre>
<pre>67</pre>
<pre>68</pre>
<pre>69</pre>
<pre>70</pre>
<pre>71</pre>
<pre>72</pre>

<pre>76</pre>
<pre>77</pre>
<pre>78</pre>
<pre>79</pre>
<pre>80</pre>
<pre>81</pre>
<pre>82</pre>
<pre>83</pre>
<pre>84</pre>
<pre>85</pre>
<pre>86</pre>
<pre>87</pre>
<pre>88</pre>
<pre>89</pre>
<pre>90</pre>
<pre>91</pre>
</div>
<div>
<pre class=""> background-image: url(/message-mine.png)</pre>
<pre class=""> }</pre>

<pre class=""> .message-text {</pre>
<pre class=""> .text {</pre>
<pre class=""> padding: 5px 7px;</pre>
<pre class=""> word-wrap: break-word;</pre>

<pre class=""><span class="">...some lines skipped...</span></pre>
<pre class=""> }</pre>
<pre class=""> }</pre>

<pre class=""> .picture {</pre>
<pre class=""> padding: 4px 4px 0;</pre>

<pre class=""> img {</pre>
<pre class=""> width: 220px;</pre>
<pre class=""> height: 130px;</pre>
<pre class=""> border-radius: 6px;</pre>
<pre class=""> }</pre>
<pre class=""> }</pre>

<pre class=""> .message-timestamp {</pre>
<pre class=""> position: absolute;</pre>
<pre class=""> bottom: 2px;</pre>
</div>
</div>
</div>
<p><br>We also want to add image icon on the chats list in case of the last message is an image message, so let&#x2019;s add it:</p>

<div>
<div>
<div>
<pre>12</pre>
<pre>13</pre>
<pre>14</pre>
<pre>15</pre>
<pre>16</pre>
<pre>17</pre>
<pre>18</pre>
<pre>19</pre>
<pre>20</pre>
<pre>21</pre>
</div>
<div>
<pre class=""> href="#/tab/chats/"&gt;</pre>
<pre class=""> <span class="">&lt;<span class="">img</span> <span class="">ng-src</span>=<span class="">""</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">h2</span>&gt;</span><span class="">&lt;/<span class="">h2</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ng-switch</span> <span class="">on</span>=<span class="">"chat.lastMessage.type"</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span> <span class="">ng-switch-when</span>=<span class="">"text"</span>&gt;</span><span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">p</span> <span class="">ng-switch-when</span>=<span class="">"picture"</span>&gt;</span>image<span class="">&lt;/<span class="">p</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;/<span class="">ng-switch</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">span</span> <span class="">class</span>=<span class="">"last-message-timestamp"</span>&gt;</span><span class="">&lt;/<span class="">span</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">i</span> <span class="">class</span>=<span class="">"icon ion-chevron-right icon-accessory"</span>&gt;</span><span class="">&lt;/<span class="">i</span>&gt;</span></pre>
<pre class=""> <span class="">&lt;<span class="">ion-option-button</span> <span class="">class</span>=<span class="">"button-assertive"</span> <span class="">ng-click</span>=<span class="">"remove(chat)"</span>&gt;</span></pre>
</div>
</div>
</div>
<p><br>And this is the result:</p>
<p><img src="http://cdn2.hubspot.net/hubfs/520701/17_-_Photo_in_chat_message.png?t=1445014944449" title=""></p><p>You can download a ZIP file with the project at this point <a href="https://github.com/dotansimha/meteor-whatsapp-clone-step-by-step/archive/8b3e83fcb112bca6f1f90caf822a8d8938f39c30.zip"><span>here</span></a>.</p><p><strong><span>Summary</span></strong></p>
<p>Congratulations! You&#x2019;ve created a WhatsApp app!</p>
<p>Thanks a lot to <a href="https://github.com/idanwe/" target="_blank">Idan Wender</a> and <a href="https://github.com/dotansimha" target="_blank">Dotan Simha</a> who helped me a lot with this&#xA0;post.</p>
<p>You are welcome to add more features and extend this tutorial by pull requesting <a href="https://github.com/idanwe/meteor-whatsapp"><span>this repository</span></a>.</p>
<p>Next steps:</p>
</div>
 </div>
</body></html>
