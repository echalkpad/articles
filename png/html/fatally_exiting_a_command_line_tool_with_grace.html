<!DOCTYPE html><html><head><title>Fatally exiting a command line tool, with grace</title></head><body>
<h1>Fatally exiting a command line tool, with grace</h1><p><a href="https://medium.com/@matryer/golang-advent-calendar-day-three-fatally-exiting-a-command-line-tool-with-grace-874befeb64a4" target="_new">Original URL</a></p>
<p><blockquote>Go is really great for writing command line tools because you can do some pretty powerful things, with very little code.Like C, the `main` function is where the program starts, and when the main&hellip;</blockquote></p>
<section name="d17f" class=" section--body section--first section--last" score="41.25"><div class="section-content" score="31.25"><div class="section-inner layoutSingleColumn"><p name="d28e" id="d28e" class="graf--p graf-after--h3">Go is really great for writing command line tools because you can do some pretty powerful things, with very little code.</p><p name="9eab" id="9eab" class="graf--p graf-after--p">Like C, the `main` function is where the program starts, and when the main function exits, the program exits. Nice and simple. This means you can use the defer keyword to run code just before your program exits (such as closing files, cleaning up database connections, and even saying goodbye.)</p><p name="22f4" id="22f4" class="graf--p graf-after--p">A simple program that reads items from a database and writes them to a text file might look like this:</p><pre name="518b" id="518b" class="graf--pre graf-after--p">package main</pre><pre name="aaad" id="aaad" class="graf--pre graf-after--pre">func main() {</pre><pre name="a273" id="a273" class="graf--pre graf-after--pre"> // dial a database...<br> db, err := mgo.Dial("localhost")<br> if err != nil {<br> log.Fatalln(err)<br> }<br> defer db.Close()</pre><pre name="4faf" id="4faf" class="graf--pre graf-after--pre"> // open our destination file<br> f, err := os.Open("dest.txt")<br> if err != nil {<br> log.Fatalln(err)<br> }<br> defer f.Close()</pre><pre name="9d7a" id="9d7a" class="graf--pre graf-after--pre"> // get a function to do the work for us<br> doCopy(db, f)</pre><pre name="4dda" id="4dda" class="graf--pre graf-after--pre">}</pre><p name="c04e" id="c04e" class="graf--p graf-after--pre">The trouble is, `log.Fatalln` causes the program to exit immediately, not allowing any deferred functions to run. Similarly, calls to `os.Exit` would do the same. <a href="http://play.golang.org/p/x9dkjA-4Ok" class="markup--anchor markup--p-anchor" rel="nofollow">See this happening for yourself</a>.</p><blockquote name="68d4" id="68d4" class="graf--blockquote graf-after--p">DID YOU KNOW: Deferred functions are called in the reverse order in which they were added.</blockquote><p name="fc5a" id="fc5a" class="graf--p graf-after--blockquote">To solve this problem, we can use a variable to hold an error, and defer a function that will run last (since we defer it first,) that checks the error and exits with a suitable code.</p><p name="5c26" id="5c26" class="graf--p graf-after--p">Modify the main function:</p><pre name="2d58" id="2d58" class="graf--pre graf-after--p">package main</pre><pre name="ebce" id="ebce" class="graf--pre graf-after--pre">func main() {<br> var err error<br> defer func(){<br> if err != nil {<br> log.Fatalln(err)<br> }<br> }()</pre><pre name="1e5b" id="1e5b" class="graf--pre graf-after--pre"> // dial a database...<br> db, err := mgo.Dial("localhost")<br> if err != nil {<br> return<br> }<br> defer db.Close()</pre><pre name="e72e" id="e72e" class="graf--pre graf-after--pre"> // open our destination file<br> f, err := os.Open("dest.txt")<br> if err != nil {<br> return<br> }<br> defer f.Close()</pre><pre name="9bbd" id="9bbd" class="graf--pre graf-after--pre"> // get a function to do the work for us<br> doCopy(db, f)</pre><pre name="6880" id="6880" class="graf--pre graf-after--pre">}</pre><p name="1ec9" id="1ec9" class="graf--p graf-after--pre">Now, should something go wrong, the deferred calls to db.Close, and f.Close will be called before the main function exits. The error will still be logged out as before. <a href="http://play.golang.org/p/6pBCp_47cs" class="markup--anchor markup--p-anchor" rel="nofollow">See this happening in our simplified version</a>.</p><p name="8644" id="8644" class="graf--p graf-after--h4 graf--last">Please post links to other solutions to these kinds of problems, or alternative solutions to this one, the little tips and tricks are great to have in the old toolbelt.</p></div></div></section>
</body></html>
