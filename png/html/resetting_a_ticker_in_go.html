<!DOCTYPE html><html><head><title>Resetting a ticker in Go</title></head><body>
<h1>Resetting a ticker in Go</h1><p><a href="https://medium.com/@arpith/resetting-a-ticker-in-go-63858a2c17ec" target="_new">Original URL</a></p>
<p><blockquote>Raft is the distributed consensus algorithm that I’m using for the database I’m building at the</blockquote></p>
<section name="a22d" class=" section--body section--first section--last" score="41.25"><div class="section-content" score="31.25"><div class="section-inner layoutSingleColumn"><p name="8b26" id="8b26" class="graf--p graf-after--h3"><a href="https://raft.github.io/" class="markup--anchor markup--p-anchor" rel="nofollow">Raft</a> is the distributed consensus algorithm that I’m using for the <a href="https://github.com/arpith/mmapd" class="markup--anchor markup--p-anchor" rel="nofollow">database</a> <a href="https://medium.com/@arpith/adventures-with-mmap-463b33405223#.kbv1sdpce" class="markup--anchor markup--p-anchor">I’m</a> <a href="https://medium.com/@arpith/go-sharing-memory-by-communicating-in-practice-4761bbe5dcf1#.49fe4mdon" class="markup--anchor markup--p-anchor">building</a> <a href="https://medium.com/@arpith/reading-a-go-map-safely-277bb08ed144#.vjbxfptm9" class="markup--anchor markup--p-anchor">at</a> the <a href="http://recurse.com" class="markup--anchor markup--p-anchor" rel="nofollow">Recurse Center</a>. The <a href="https://raft.github.io/raft.pdf" class="markup--anchor markup--p-anchor" rel="nofollow">algorithm</a> has <a href="http://thesecretlivesofdata.com/raft/#election" class="markup--anchor markup--p-anchor" rel="nofollow">two timeouts</a> — a heartbeat timeout and an election timeout. When a server receives a heartbeat from the leader, it resets its election timeout. If it doesn’t receive a heartbeat before its election timeout runs out, it tries to elect itself as leader!</p><p name="d0a2" id="d0a2" class="graf--p graf-after--p">As a first step towards this, I need to write code that resets a timeout (say 2 seconds) every time another timeout (say 5 seconds) expires. I would expect to see output that looked like:</p><pre name="da8e" id="da8e" class="graf--pre graf-after--p">Elapsed: 0<br>Elapsed: 2 Ticker A<br>Elapsed: 4 Ticker A<br>Elapsed: 5 Ticker B - Going to reset Ticker A!<br>Elapsed: 7 Ticker A<br>Elapsed: 9 Ticker A</pre><p name="4660" id="4660" class="graf--p graf-after--pre">If I hadn’t reset the other ticker, of course, I would expect to see:</p><pre name="e0b8" id="e0b8" class="graf--pre graf-after--p">Elapsed: 0 <br>Elapsed: 2 Ticker A<br>Elapsed: 4 Ticker A<br>Elapsed: 5 Ticker B<br>Elapsed: 6 Ticker A<br>Elapsed: 8 Ticker A</pre><p name="44b1" id="44b1" class="graf--p graf-after--pre">Here’s how I wrote this in Go, using <a href="https://golang.org/pkg/time/#Tick" class="markup--anchor markup--p-anchor" rel="nofollow">ticking channels</a>. I set up a goroutine that listens on two channels, tickerA and tickerB. Every time tickerB goes off, it resets tickerA.</p><pre name="3f77" id="3f77" class="graf--pre graf-after--p">type server struct {<br> doneChan chan bool<br> tickerA ticker<br> tickerB ticker<br>}</pre><pre name="8ba2" id="8ba2" class="graf--pre graf-after--pre">func (s *server) listener() {<br> start := time.Now()<br> for {<br> select {<br> case &lt;-s.tickerA.ticker:<br> elapsed := time.Since(start)<br> fmt.Println("Elapsed: ", elapsed, " Ticker A")<br> case &lt;-s.tickerB.ticker:<br> s.tickerA.resetTicker()<br> elapsed := time.Since(start)<br> fmt.Println("Elapsed: ", elapsed, " Ticker B - Going to reset ticker A")<br> }<br> }<br> s.doneChan &lt;- true<br>}</pre><pre name="37db" id="37db" class="graf--pre graf-after--pre">func main() {<br> doneChan := make(chan bool)<br> tickerA := createTicker(2 articles _articles bin CAs devops Documents dotfiles gethtml go hnews jason js MITIE netdata png pngquant start-thesrc thesrc ucii time.Second)<br> tickerB := createTicker(5 articles _articles bin CAs devops Documents dotfiles gethtml go hnews jason js MITIE netdata png pngquant start-thesrc thesrc ucii time.Second)<br> s := &amp;server{doneChan, *tickerA, *tickerB}<br> go s.listener()<br> &lt;-doneChan<br>}</pre><p name="5cef" id="5cef" class="graf--p graf-after--pre">And my tickers and the methods to create and reset them look like:</p><pre name="ac2c" id="ac2c" class="graf--pre graf-after--p">type ticker struct {<br> period time.Duration<br> ticker &lt;-chan time.Time<br>}</pre><pre name="950c" id="950c" class="graf--pre graf-after--pre">func createTicker(period time.Duration) *ticker {<br> return &amp;ticker{period, time.Tick(period)}<br>}</pre><pre name="5019" id="5019" class="graf--pre graf-after--pre">func (t *ticker) resetTicker() {<br> t.ticker = time.Tick(t.period)<br>}</pre><p name="e147" id="e147" class="graf--p graf-after--pre">The actual output is:</p><pre name="fd8d" id="fd8d" class="graf--pre graf-after--p">$ go run tick.go</pre><pre name="f740" id="f740" class="graf--pre graf-after--pre">Elapsed: 2.00074535s Ticker A</pre><pre name="0404" id="0404" class="graf--pre graf-after--pre">Elapsed: 4.002086857s Ticker A</pre><pre name="ed08" id="ed08" class="graf--pre graf-after--pre">Elapsed: 5.004973744s Ticker B - Going to reset ticker A</pre><pre name="ed29" id="ed29" class="graf--pre graf-after--pre">Elapsed: 7.008515813s Ticker A</pre><pre name="61f8" id="61f8" class="graf--pre graf-after--pre">Elapsed: 9.009572001s Ticker A</pre><p name="bf64" id="bf64" class="graf--p graf-after--pre">That’s about it! <a href="https://play.golang.org/p/Hj9I8j_IFb" class="markup--anchor markup--p-anchor" rel="nofollow">Check it out</a>!</p><p name="6ae5" id="6ae5" class="graf--p graf-after--p graf--last">Have a better way to do this? Just want to say hi? <a href="http://arpith.co" class="markup--anchor markup--p-anchor" rel="nofollow">I’m</a> <a href="http://twitter.com/arpith" class="markup--anchor markup--p-anchor" rel="nofollow">on Twitter</a>!</p></div></div></section>
</body></html>
