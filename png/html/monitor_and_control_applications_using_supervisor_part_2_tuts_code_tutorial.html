<!DOCTYPE html><html><head><title>Monitor and Control Applications Using Supervisor: Part 2 - Tuts+ Code Tutorial</title></head><body>
<h1>Monitor and Control Applications Using Supervisor: Part 2 - Tuts+ Code Tutorial</h1><p><a href="http://code.tutsplus.com/tutorials/monitor-and-control-applications-using-supervisor-part-2--cms-24236" target="_new">Original URL</a></p>
<p><blockquote>In the first part of this two-part tutorial series, we saw to set up and control Supervisor to work with our web applications. In this part, we will see how we can programmatically control Supervisor&hellip;</blockquote></p>
<div><div class="post-body__content"><p>In the <a href="http://code.tutsplus.com/tutorials/monitor-and-control-applications-using-supervisor-part-1--cms-23770" rel="external" target="_blank">first</a> part of this two-part tutorial series, we saw to set up and control Supervisor to work with our web applications. In this part, we will see how we can programmatically control Supervisor processes remotely via the&#xA0;<a href="http://supervisord.org/api.html" rel="external" target="_blank">XML-RPC API</a>.</p><h2>Getting Started</h2><p>In the previous part, we saw that Supervisor provides a web-based GUI which allows us to remotely control the processes with the help of a few clicks. Below is a screenshot of this GUI&#xA0;for the application we created in the previous part:</p><figure class="post_image"><img alt="Supervisor" src="https://cms-assets.tutsplus.com/uploads/users/665/posts/24236/image/Screen%20Shot%202015-06-22%20at%2010.42.17%20am.png"></figure><p>A question immediately starts ringing in the brain. What if it were possible to control the Supervisor processes programmatically? This would open up a lot of possibilities where processes can be started or stopped conditionally rather than having them run indefinitely or controlling them manually by clicking buttons or running terminal commands. This is very much possible using the XML-RPC API provided by Supervisor.</p><h2>The XML-RPC API</h2><p>The API itself is pretty straightforward and easy to use. We saw that the HTTP server for Supervisor runs on port 9001 by default. The same can be used to connect using any XML-RPC library. In the case of Python, we can simply use the built-in <code class="inline">xmlrpclib</code>. Assuming that the Supervisor server runs on&#xA0;<a href="http://localhost:9001/" rel="external" target="_blank">http://localhost:9001/</a>:</p><pre class="brush: python noskimlinks noskimwords">&gt;&gt;&gt; import xmlrpclib
&gt;&gt;&gt; server = xmlrpclib.Server('http://localhost:9001/RPC2')</pre><p>To check the current state of the Supervisor server, run:</p><pre class="brush: python noskimlinks noskimwords">&gt;&gt;&gt; server.supervisor.getState()
{'statename': 'RUNNING', 'statecode': 1}</pre><p>The server daemon can be restarted and stopped by:</p><pre class="brush: python noskimlinks noskimwords">&gt;&gt;&gt; server.supervisor.restart()
&gt;&gt;&gt; server.supervisor.shutdown()</pre><p>Similarly, the list of all available methods can be fetched by:</p><pre class="brush: python noskimlinks noskimwords">&gt;&gt;&gt; server.system.listMethods()</pre><p>The <a href="http://supervisord.org/api.html" rel="external" target="_blank">API reference</a> provided in the&#xA0;Supervisor documentation is pretty clean and self-explanatory. Going ahead in this tutorial, I will cover an example of how to control the processes based on a condition, and also how we can extend this API in order to implement our own methods.</p><h2>Controlling Processes Using the API<br>
</h2><p>Lets say we want a start a new&#xA0;process to send an email&#xA0;every time an action is performed by some user. (There are many ways of doing this, and maybe this is not the best one, but I am just using it as an example to demonstrate this). Let's say the name of this process as defined in&#xA0;<code class="inline">supervisord.conf</code> is <code class="inline">send_mail</code>.</p><pre class="brush: python noskimlinks noskimwords">if user.action_performed:
 server.supervisor.startProcess('send_email')</pre><p>Similarly, we can also trigger automatic&#xA0;restarting of&#xA0;the <code class="inline">supervisord</code> server daemon in case we have a code change in our application.</p><pre class="brush: python noskimlinks noskimwords">if app.code_change():
 server.supervisor.restart()</pre><p>This API can similarly be applied to countless such instances.&#xA0;</p><h2>Extending the XML-RPC API</h2><p>We can not only use the standard API methods provided by Supervisor but also write our own methods, extending the API by using the XML-RPC interface factories. This can simply be done by adding a new <code class="inline">[rpcinterface:x]</code>&#xA0;section in&#xA0;<code class="inline">supervisord.conf</code>.</p><pre class="brush: python noskimlinks noskimwords">[rpcinterface:custom]
supervisor.rpcinterface_factory = my_interface:make_custom_rpcinterface</pre><p>Now I will create a small custom interface for the same in a file named <code class="inline">my_interface.py</code>.</p><pre class="brush: python noskimlinks noskimwords">from supervisor.rpcinterface import SupervisorNamespaceRPCInterface


class CustomRPCInterface:
 def __init__(self, supervisord):
 self.supervisord = supervisord
 self.retries = 3

 def startProcessOrRetry(self, name, wait=True):
 interface = SupervisorNamespaceRPCInterface(self.supervisord)
 retry = 0

 while not interface.startProcess(name) or retry &lt; self.retries:
 retry = retry + 1
 
 
# this is not used in code but referenced via an entry point in the conf file
def make_custom_rpcinterface(supervisord):
 return CustomRPCInterface(supervisord)</pre><p>Above, I have created a method which when called will retry the process three times in case of failure to start.</p><h2>Conclusion</h2><p>In this tutorial series, we learnt how to use Supervisor to monitor and control our applications. We also saw how we can use the Web UI and XML-RPC Interface for the same. Finally, the XML-RPC interface is extended in order to leverage the power of Supervisor to our benefit.</p></div></div>
</body></html>
